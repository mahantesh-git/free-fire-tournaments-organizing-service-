<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fire Live Scoreboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Exo+2:wght@400;600;700;800&display=swap');
        
        * {
            font-family: 'Exo 2', sans-serif;
        }
        
        body {
            background: #0b0e17;
            position: relative;
            overflow-x: hidden;
        }
        
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(180deg, #0b0e17 0%, #1a1d2e 50%, #0b0e17 100%);
        }
        
        .content {
            position: relative;
            z-index: 1;
        }
        
        .card {
            background: rgba(20, 24, 38, 0.95);
            border: 1px solid rgba(255, 68, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .accent-border {
            border-left: 3px solid #ff4400;
        }
        
        .top-player {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.08), transparent);
            border-left: 3px solid #ffd700;
        }
        
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 48px;
            padding: 0 12px;
            background: rgba(255, 68, 0, 0.1);
            border: 1px solid rgba(255, 68, 0, 0.3);
            color: #ff6633;
            font-weight: 700;
            font-size: 18px;
        }
        
        .rank-badge.top-3 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border-color: #ffd700;
            color: #ffd700;
            font-weight: 800;
            font-size: 20px;
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(30, 35, 50, 0.5);
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(255, 68, 0, 0.4);
            border-radius: 4px;
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        thead th {
            position: sticky;
            top: 0;
            background: rgba(20, 24, 38, 0.98);
            z-index: 10;
        }
        
        tbody tr {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        tbody tr:hover {
            background: rgba(255, 68, 0, 0.05);
        }

        @keyframes rankUp {
            0% {
                background: rgba(16, 185, 129, 0.3);
                transform: translateX(-10px);
            }
            100% {
                background: transparent;
                transform: translateX(0);
            }
        }

        @keyframes rankDown {
            0% {
                background: rgba(239, 68, 68, 0.3);
                transform: translateX(10px);
            }
            100% {
                background: transparent;
                transform: translateX(0);
            }
        }

        .rank-up {
            animation: rankUp 1s ease-out;
        }

        .rank-down {
            animation: rankDown 1s ease-out;
        }

        .row-moving {
            z-index: 5;
        }
        
        .stat-item {
            background: rgba(30, 35, 50, 0.6);
            border: 1px solid rgba(255, 68, 0, 0.15);
        }

        .top-players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .top-player-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .top-player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffd700, #ff8c00);
        }

        .top-player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 20px;
            color: #ef4444;
            font-weight: 700;
            font-size: 14px;
            animation: pulse 2s ease-in-out infinite;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideIn 0.5s ease-out;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 800;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .score-updated {
            animation: scorePopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scorePopIn {
            0% {
                transform: scale(1);
                color: inherit;
            }
            50% {
                transform: scale(1.4);
                color: #10b981;
                filter: drop-shadow(0 0 10px #10b981);
            }
            100% {
                transform: scale(1);
                color: inherit;
            }
        }

        .kill-increment {
            position: absolute;
            font-size: 1.2rem;
            font-weight: 800;
            color: #10b981;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.2);
            }
        }

        .map-score-cell {
            position: relative;
            transition: all 0.3s ease;
        }

        .map-score-updated {
            animation: mapScoreFlash 0.8s ease-out;
        }

        @keyframes mapScoreFlash {
            0%, 100% {
                background: transparent;
            }
            50% {
                background: rgba(16, 185, 129, 0.3);
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
            }
        }

        .new-kill-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            animation: badgePulse 1s ease-in-out;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.9;
            }
        }

        .refresh-icon {
            display: inline-block;
            transition: transform 0.5s ease;
        }

        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .last-updated {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 68, 0, 0.9);
            border: 2px solid rgba(255, 68, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 68, 0, 0.4);
        }

        .fullscreen-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 68, 0, 1);
            box-shadow: 0 6px 30px rgba(255, 68, 0, 0.6);
        }

        .team-card {
            transition: all 0.3s ease;
        }

        .team-card:hover {
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <div class="content p-4 md:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card rounded-lg p-6 mb-6 shadow-xl fade-in">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                            <span class="text-orange-500">FREE FIRE</span> TOURNAMENT
                        </h1>
                        <p class="text-gray-400 text-sm font-medium">Live Scoreboard</p>
                    </div>
                    
                    <div class="flex gap-6 items-center flex-wrap">
                        <div class="live-indicator">
                            <span class="live-dot"></span>
                            <span>LIVE</span>
                        </div>
                        <div class="stat-item rounded px-6 py-3">
                            <div class="text-3xl font-bold text-white" id="totalPlayers">0</div>
                            <div class="text-xs text-gray-400 uppercase">Players</div>
                        </div>
                        <div class="stat-item rounded px-6 py-3">
                            <div class="text-3xl font-bold text-orange-500" id="totalKills">0</div>
                            <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 flex items-center justify-between">
                    <div class="last-updated">
                        <span class="refresh-icon" id="refreshIcon">üîÑ</span>
                        Last updated: <span id="lastUpdated">--:--:--</span>
                    </div>
                    
                </div>
            </div>

            <!-- Top Players Section -->
            <div id="topPlayersSection" class="card rounded-lg p-6 mb-6 shadow-xl" style="display: none;">
                <h2 class="text-3xl font-bold text-white mb-6 flex items-center gap-3">
                    <span>üèÜ</span>
                    <span>TOP PLAYERS</span>
                </h2>
                <div id="topPlayersContainer" class="top-players-grid"></div>
            </div>

            <!-- Teams Section -->
            <div id="teamsSection" class="mb-6" style="display: none;">
                <div class="card rounded-lg p-6 mb-4 shadow-xl">
                    <h2 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                        <span>üéÆ</span>
                        <span>ACTIVE TEAMS</span>
                    </h2>
                    <p class="text-gray-400 text-sm">Live team standings and scores</p>
                </div>
                <div id="teamsContainer"></div>
            </div>

            <!-- Score Table -->
            <div class="card rounded-lg shadow-xl overflow-hidden fade-in">
                <div class="p-6 border-b border-gray-700">
                    <h2 class="text-2xl font-bold text-white">LEADERBOARD</h2>
                </div>
                
                <div class="overflow-x-auto scrollbar-custom" style="max-height: 70vh;">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="p-5 text-gray-400 font-bold uppercase text-sm">Rank</th>
                                <th class="p-5 text-gray-400 font-bold uppercase text-sm">Player Name</th>
                                <th class="p-5 text-gray-400 font-bold uppercase text-sm">FF Name</th>
                                <th class="p-5 text-center text-gray-400 font-bold uppercase text-sm">Bermuda</th>
                                <th class="p-5 text-center text-gray-400 font-bold uppercase text-sm">Purgatory</th>
                                <th class="p-5 text-center text-gray-400 font-bold uppercase text-sm">Kalahari</th>
                                <th class="p-5 text-center text-orange-500 font-bold uppercase text-sm">Total Kills</th>
                            </tr>
                        </thead>
                        <tbody id="scoreTableBody" class="text-white">
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyState" class="text-center py-24">
                    <div class="text-gray-600 text-6xl mb-4">üìä</div>
                    <p class="text-gray-400 text-xl font-semibold">No Data Available</p>
                    <p class="text-gray-500 text-sm mt-2">Waiting for tournament data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Button -->
    <div class="fullscreen-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen">
        <span class="text-white text-2xl">‚õ∂</span>
    </div>

    <script>
        let players = [];
        let selectedTopPlayers = [];
        let randomTeams = [];
        let lastUpdateTime = null;
        let previousScores = {};
        let previousRanks = {};
        let previousMapScores = {};
        
        function getAPIBase() {
            if (window.location.hostname.includes('ngrok')) {
                return `${window.location.protocol}//${window.location.hostname}/api`;
            }
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:9000/api';
            }
            return `${window.location.protocol}//${window.location.hostname}/api`;
        }
        
        const API_BASE = getAPIBase();
        console.log('üîó API Base URL:', API_BASE);

        window.onload = function() {
            loadData();
            setInterval(loadData, 5000); // Auto-refresh every 5 seconds
        };

        async function loadData() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('spinning');
            
            try {
                await Promise.all([
                    loadGameState(),
                    loadPlayers()
                ]);
                
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                refreshIcon.classList.remove('spinning');
            }
        }

        async function loadGameState() {
            try {
                const response = await fetch(`${API_BASE}/gamestate`);
                const data = await response.json();
                
                if (data && data.active) {
                    randomTeams = data.randomTeams || [];
                    selectedTopPlayers = data.selectedTopPlayers || [];
                }
            } catch (error) {
                console.error('Error loading game state:', error);
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE}/kills/getPlayers`);
                const data = await response.json();
                
                // Store previous scores, ranks, and map scores for animation
                players.forEach((p, index) => {
                    previousScores[p._id] = p.total;
                    previousRanks[p._id] = index + 1;
                    previousMapScores[p._id] = {
                        map1: p.map1,
                        map2: p.map2,
                        map3: p.map3
                    };
                });
                
                players = data.map(player => ({
                    _id: player._id,
                    playerName: player.playerName,
                    ffName: player.ffName,
                    ffId: player.ffId,
                    map1: player.map1 || 0,
                    map2: player.map2 || 0,
                    map3: player.map3 || 0,
                    total: player.total || 0
                }));
                
                sortAndRank();
                displayTopPlayers();
                displayTeams();
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastUpdated').textContent = timeString;
            lastUpdateTime = now;
        }

        function displayTopPlayers() {
            const section = document.getElementById('topPlayersSection');
            const container = document.getElementById('topPlayersContainer');
            
            if (selectedTopPlayers.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            const topPlayers = players.filter(p => selectedTopPlayers.includes(p._id));
            
            container.innerHTML = topPlayers.map((player) => {
                const rank = players.indexOf(player) + 1;
                const teamInfo = getPlayerTeamInfo(player._id);
                
                return `
                    <div class="top-player-card">
                        <div class="text-5xl font-black text-yellow-400 mb-3">#${rank}</div>
                        <div class="text-xl font-bold text-white mb-2">${player.playerName}</div>
                        <div class="text-sm text-gray-400 mb-3">${player.ffName}</div>
                        ${teamInfo ? `
                            <div class="text-xs font-bold text-blue-400 mb-3">
                                Room ${teamInfo.room} ‚Ä¢ Team ${teamInfo.team}
                            </div>
                        ` : ''}
                        <div class="text-3xl font-bold text-orange-500">${player.total} Kills</div>
                    </div>
                `;
            }).join('');
            
            section.style.display = 'block';
        }

        function getPlayerTeamInfo(playerId) {
            const TEAMS_PER_ROOM = 12;
            
            for (let i = 0; i < randomTeams.length; i++) {
                const team = randomTeams[i];
                const playerInTeam = team.find(p => p._id === playerId);
                
                if (playerInTeam) {
                    const roomNumber = Math.floor(i / TEAMS_PER_ROOM) + 1;
                    const teamNumber = i + 1;
                    return { room: roomNumber, team: teamNumber };
                }
            }
            
            return null;
        }

        function displayTeams() {
            const section = document.getElementById('teamsSection');
            const container = document.getElementById('teamsContainer');
            
            if (randomTeams.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            const teamColors = [
                'rgba(59, 130, 246, 0.15)', 'rgba(16, 185, 129, 0.15)', 
                'rgba(249, 115, 22, 0.15)', 'rgba(236, 72, 153, 0.15)',
                'rgba(168, 85, 247, 0.15)', 'rgba(245, 158, 11, 0.15)', 
                'rgba(20, 184, 166, 0.15)', 'rgba(239, 68, 68, 0.15)',
            ];
            
            const borderColors = [
                '#3b82f6', '#10b981', '#f97316', '#ec4899',
                '#a855f7', '#f59e0b', '#14b8a6', '#ef4444'
            ];
            
            const TEAMS_PER_ROOM = 12;
            const rooms = [];
            for (let i = 0; i < randomTeams.length; i += TEAMS_PER_ROOM) {
                rooms.push(randomTeams.slice(i, i + TEAMS_PER_ROOM));
            }
            
            container.innerHTML = rooms.map((roomTeams, roomIndex) => {
                const roomNumber = roomIndex + 1;
                const totalRoomKills = roomTeams.reduce((sum, team) => 
                    sum + team.reduce((tSum, p) => {
                        const player = players.find(pl => pl._id === p._id);
                        return tSum + (player ? player.total : 0);
                    }, 0), 0
                );
                
                return `
                    <div class="card rounded-lg p-6 mb-6 shadow-xl fade-in">
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-700">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
                                    <span class="text-3xl font-black text-white">${roomNumber}</span>
                                </div>
                                <div>
                                    <h3 class="text-3xl font-bold text-white">Room ${roomNumber}</h3>
                                    <p class="text-gray-400">${roomTeams.length} Teams ‚Ä¢ ${roomTeams.reduce((sum, t) => sum + t.length, 0)} Players</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-bold text-orange-500">${totalRoomKills}</div>
                                <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${roomTeams.map((team, teamIndex) => {
                                const globalTeamIndex = roomIndex * TEAMS_PER_ROOM + teamIndex;
                                const bgColor = teamColors[globalTeamIndex % teamColors.length];
                                const borderColor = borderColors[globalTeamIndex % borderColors.length];
                                
                                const teamKills = team.reduce((sum, p) => {
                                    const player = players.find(pl => pl._id === p._id);
                                    return sum + (player ? player.total : 0);
                                }, 0);
                                
                                return `
                                    <div class="team-card rounded-lg overflow-hidden" style="background: ${bgColor}; border: 2px solid ${borderColor};">
                                        <div class="flex items-center justify-between p-4 border-b" style="border-color: ${borderColor}40;">
                                            <h4 class="text-xl font-bold text-white">Team ${globalTeamIndex + 1}</h4>
                                            <div class="flex items-center gap-3">
                                                <span class="px-3 py-1 rounded text-xs font-bold" style="background: ${borderColor}30; color: ${borderColor};">
                                                    ${team.length} ${team.length === 1 ? 'Player' : 'Players'}
                                                </span>
                                                <span class="text-orange-500 font-bold text-lg">
                                                    ${teamKills} kills
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="p-4">
                                            ${team.map((p) => {
                                                const player = players.find(pl => pl._id === p._id);
                                                if (!player) return '';
                                                
                                                const scoreChanged = previousScores[player._id] !== undefined && 
                                                                    previousScores[player._id] !== player.total;
                                                
                                                return `
                                                    <div class="flex items-center justify-between py-3 border-b border-gray-700 last:border-0">
                                                        <div>
                                                            <div class="text-white font-bold">${player.playerName}</div>
                                                            <div class="text-gray-400 text-sm">${player.ffName}</div>
                                                        </div>
                                                        <div class="text-right">
                                                            <div class="score-value text-orange-500 ${scoreChanged ? 'score-updated' : ''}">
                                                                ${player.total}
                                                            </div>
                                                            <div class="text-gray-500 text-xs">kills</div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            section.style.display = 'block';
        }

        function updateStats() {
            const totalPlayers = players.length;
            const totalKills = players.reduce((sum, p) => sum + p.total, 0);

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalKills').textContent = totalKills;
        }

        function sortAndRank() {
            players.sort((a, b) => b.total - a.total);
            renderTable();
            updateStats();
        }

        function renderTable() {
            const tbody = document.getElementById('scoreTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (players.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            // Create a map of current positions
            const currentPositions = new Map();
            Array.from(tbody.children).forEach((row, index) => {
                const playerId = row.dataset.playerId;
                if (playerId) {
                    currentPositions.set(playerId, index);
                }
            });
            
            // Build new table content
            const newContent = players.map((player, index) => {
                const rank = index + 1;
                const isTop48 = rank <= 48;
                const isTop3 = rank <= 3;
                const rowClass = isTop48 ? 'top-player accent-border' : 'accent-border';
                
                const scoreChanged = previousScores[player._id] !== undefined && 
                                    previousScores[player._id] !== player.total;
                
                const killDifference = scoreChanged ? player.total - previousScores[player._id] : 0;
                
                const previousRank = previousRanks[player._id];
                let rankChangeClass = '';
                
                if (previousRank !== undefined && previousRank !== rank) {
                    if (rank < previousRank) {
                        rankChangeClass = 'rank-up';
                    } else if (rank > previousRank) {
                        rankChangeClass = 'rank-down';
                    }
                }
                
                // Check which map got new kills
                const prevMap = previousMapScores[player._id];
                const map1Changed = prevMap && prevMap.map1 !== player.map1;
                const map2Changed = prevMap && prevMap.map2 !== player.map2;
                const map3Changed = prevMap && prevMap.map3 !== player.map3;
                
                return {
                    html: `
                        <tr class="${rowClass} border-b border-gray-800 ${rankChangeClass}" data-player-id="${player._id}">
                            <td class="p-5">
                                <div class="rank-badge ${isTop3 ? 'top-3' : ''} rounded">
                                    ${rank}
                                    ${previousRank && rank < previousRank ? '<span style="color: #10b981; margin-left: 4px;">‚ñ≤</span>' : ''}
                                    ${previousRank && rank > previousRank ? '<span style="color: #ef4444; margin-left: 4px;">‚ñº</span>' : ''}
                                </div>
                            </td>
                            <td class="p-5 font-bold text-lg">${player.playerName}</td>
                            <td class="p-5 text-gray-300">${player.ffName}</td>
                            <td class="p-5 text-center map-score-cell ${map1Changed ? 'map-score-updated' : ''}" data-map="1">
                                <span class="text-white font-semibold text-lg">${player.map1}</span>
                                ${map1Changed ? `<span class="new-kill-badge">+${player.map1 - prevMap.map1}</span>` : ''}
                            </td>
                            <td class="p-5 text-center map-score-cell ${map2Changed ? 'map-score-updated' : ''}" data-map="2">
                                <span class="text-white font-semibold text-lg">${player.map2}</span>
                                ${map2Changed ? `<span class="new-kill-badge">+${player.map2 - prevMap.map2}</span>` : ''}
                            </td>
                            <td class="p-5 text-center map-score-cell ${map3Changed ? 'map-score-updated' : ''}" data-map="3">
                                <span class="text-white font-semibold text-lg">${player.map3}</span>
                                ${map3Changed ? `<span class="new-kill-badge">+${player.map3 - prevMap.map3}</span>` : ''}
                            </td>
                            <td class="p-5 text-center" style="position: relative;">
                                <span class="score-value text-orange-500 ${scoreChanged ? 'score-updated' : ''}">${player.total}</span>
                                ${killDifference > 0 ? `<span class="kill-increment">+${killDifference}</span>` : ''}
                            </td>
                        </tr>
                    `,
                    playerId: player._id,
                    newIndex: index
                };
            });
            
            // Use FLIP animation technique for smooth transitions
            const existingRows = Array.from(tbody.children);
            const rowPositions = new Map();
            
            // First: Record current positions
            existingRows.forEach(row => {
                const rect = row.getBoundingClientRect();
                const playerId = row.dataset.playerId;
                if (playerId) {
                    rowPositions.set(playerId, {
                        top: rect.top,
                        element: row
                    });
                }
            });
            
            // Last: Update DOM
            tbody.innerHTML = newContent.map(item => item.html).join('');
            
            // Invert & Play: Calculate and animate differences
            const newRows = Array.from(tbody.children);
            newRows.forEach((row, index) => {
                const playerId = row.dataset.playerId;
                const oldPosition = rowPositions.get(playerId);
                
                if (oldPosition) {
                    const newRect = row.getBoundingClientRect();
                    const deltaY = oldPosition.top - newRect.top;
                    
                    if (Math.abs(deltaY) > 1) {
                        // Apply transform instantly
                        row.style.transform = `translateY(${deltaY}px)`;
                        row.style.transition = 'none';
                        
                        // Force reflow
                        row.offsetHeight;
                        
                        // Animate to final position
                        row.style.transition = 'transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        row.style.transform = 'translateY(0)';
                    }
                }
            });
            
            // Clean up animations after they complete
            setTimeout(() => {
                newRows.forEach(row => {
                    row.style.transform = '';
                    row.style.transition = '';
                    
                    // Remove the animation classes
                    row.classList.remove('rank-up', 'rank-down');
                    
                    // Remove map score update classes
                    const mapCells = row.querySelectorAll('.map-score-updated');
                    mapCells.forEach(cell => cell.classList.remove('map-score-updated'));
                    
                    // Remove score update class
                    const scoreCell = row.querySelector('.score-updated');
                    if (scoreCell) scoreCell.classList.remove('score-updated');
                });
            }, 1500);
            
            // Remove floating kill increments after animation
            setTimeout(() => {
                const increments = document.querySelectorAll('.kill-increment');
                increments.forEach(inc => inc.remove());
                
                // Remove new kill badges
                const badges = document.querySelectorAll('.new-kill-badge');
                badges.forEach(badge => badge.remove());
            }, 1500);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F11' || (e.key === 'f' && e.ctrlKey)) {
                e.preventDefault();
                toggleFullscreen();
            }
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                loadData();
            }
        });
    </script>
</body>
</html>