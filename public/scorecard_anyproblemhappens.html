<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fire Tournament Score Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Exo+2:wght@400;600;700;800&display=swap');
        
        * {
            font-family: 'Exo 2', sans-serif;
        }
        
        body {
            background: #0b0e17;
            position: relative;
            overflow-x: hidden;
        }
        
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(180deg, #0b0e17 0%, #1a1d2e 50%, #0b0e17 100%);
        }
        
        .content {
            position: relative;
            z-index: 1;
        }
        
        .card {
            background: rgba(20, 24, 38, 0.95);
            border: 1px solid rgba(255, 68, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .accent-border {
            border-left: 3px solid #ff4400;
        }
        
        .top-player {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.08), transparent);
            border-left: 3px solid #ffd700;
        }
        
        input[type="text"], input[type="number"], select {
            background: rgba(30, 35, 50, 0.8);
            border: 1px solid rgba(255, 68, 0, 0.2);
            color: #fff;
            transition: all 0.2s ease;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #ff4400;
            background: rgba(30, 35, 50, 1);
        }

        input[type="number"][readonly] {
            background: rgba(30, 35, 50, 0.4);
            border: 1px solid rgba(255, 68, 0, 0.1);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn {
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 0 8px;
            background: rgba(255, 68, 0, 0.1);
            border: 1px solid rgba(255, 68, 0, 0.3);
            color: #ff6633;
            font-weight: 700;
            font-size: 14px;
        }
        
        .rank-badge.top-3 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border-color: #ffd700;
            color: #ffd700;
            font-weight: 800;
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(30, 35, 50, 0.5);
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(255, 68, 0, 0.4);
            border-radius: 4px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 68, 0, 0.6);
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        thead th {
            position: sticky;
            top: 0;
            background: rgba(20, 24, 38, 0.98);
            z-index: 10;
        }
        
        tbody tr {
            transition: background 0.15s ease;
        }
        
        tbody tr:hover {
            background: rgba(255, 68, 0, 0.05);
        }
        
        .stat-item {
            background: rgba(30, 35, 50, 0.6);
            border: 1px solid rgba(255, 68, 0, 0.15);
        }
        
        .delete-btn {
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            opacity: 1;
            color: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: rgba(20, 24, 38, 0.98);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid rgba(255, 68, 0, 0.3);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #ff4400;
        }

        .top-players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .top-player-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .checkbox-player {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background: #10b981;
        }

        .alert-error {
            background: #ef4444;
        }

        .alert-warning {
            background: #f59e0b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .game-status-badge {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .game-status-active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            border: 2px solid #10b981;
            color: #10b981;
        }

        .game-status-inactive {
            background: rgba(107, 114, 128, 0.2);
            border: 2px solid #6b7280;
            color: #9ca3af;
        }

        .lock-icon {
            display: inline-block;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <div class="content p-4 md:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card rounded-lg p-6 mb-6 shadow-xl">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white mb-1">
                            <span class="text-orange-500">FREE FIRE</span> TOURNAMENT
                        </h1>
                        <p class="text-gray-400 text-sm font-medium">Live Scoreboard</p>
                    </div>
                    
                    <!-- Stats & Game Status -->
                    <div class="flex gap-6 items-center">
                        <div id="gameStatusBadge" class="game-status-badge game-status-inactive">
                            <span class="lock-icon">üéÆ</span>
                            <span id="gameStatusText">No Active Game</span>
                        </div>
                        <div class="stat-item rounded px-4 py-2">
                            <div class="text-2xl font-bold text-white" id="totalPlayers">0</div>
                            <div class="text-xs text-gray-400 uppercase">Players</div>
                        </div>
                        <div class="stat-item rounded px-4 py-2">
                            <div class="text-2xl font-bold text-orange-500" id="totalKills">0</div>
                            <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="card rounded-lg p-5 mb-6 shadow-xl">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    <button onclick="showTopPlayersModal()" class="btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded text-sm">
                        TOP PLAYERS
                    </button>
                    <button onclick="generateRandomTeams()" id="randomTeamsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded text-sm">
                        RANDOM TEAMS
                    </button>
                    <button onclick="toggleTeamsView()" id="viewTeamsBtn" class="btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded text-sm" style="display: none;">
                        üëÅÔ∏è VIEW TEAMS
                    </button>
                    <button onclick="endGame()" id="endGameBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded text-sm" style="display: none;">
                        END GAME
                    </button>
                    <button onclick="loadPlayers()" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded text-sm">
                        REFRESH
                    </button>
                    <button onclick="showExportModal()" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded text-sm">
                        EXPORT
                    </button>
                    <button onclick="clearAllData()" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded text-sm">
                        CLEAR ALL
                    </button>
                </div>
            </div>

            <!-- Top Players Section -->
            <div id="topPlayersSection" class="card rounded-lg p-5 mb-6 shadow-xl" style="display: none;">
                <h2 class="text-2xl font-bold text-white mb-4">üèÜ TOP PLAYERS</h2>
                <div id="topPlayersContainer" class="top-players-grid"></div>
            </div>

            <!-- Random Teams Section -->
            <div id="randomTeamsSection" style="display: none;">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-3xl font-bold text-white">üé≤ RANDOM TEAMS</h2>
                </div>
                <div id="randomTeamsContainer" class="space-y-6"></div>
            </div>

            <!-- Score Table -->
            <div class="card rounded-lg shadow-xl overflow-hidden">
                <div class="overflow-x-auto scrollbar-custom" style="max-height: 70vh;">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">Select</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">Rank</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">Player Name</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">FF Name</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">FF ID</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Bermuda</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Purgatory</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Kalahari</th>
                                <th class="p-4 text-center text-orange-500 font-bold uppercase text-xs">Total</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Action</th>
                            </tr>
                        </thead>
                        <tbody id="scoreTableBody" class="text-white">
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyState" class="text-center py-20">
                    <div class="text-gray-600 text-5xl mb-4">üìä</div>
                    <p class="text-gray-400 text-lg font-semibold">No Players Added</p>
                    <p class="text-gray-500 text-sm mt-2">Add players to begin tracking scores</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeExportModal()">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4">Export Options</h2>
            <p class="text-gray-400 text-sm mb-4">Choose export format:</p>
            <div class="space-y-3">
                <button onclick="exportXLSX('singles')" class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                    üìä EXPORT AS SINGLES
                </button>
                <button onclick="exportXLSX('squads')" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded text-sm w-full" id="exportSquadsBtn">
                    üë• EXPORT AS SQUADS
                </button>
                <button onclick="exportXLSX('both')" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                    üìë EXPORT BOTH (2 Sheets)
                </button>
            </div>
            <button onclick="closeExportModal()" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm w-full mt-4">
                CANCEL
            </button>
        </div>
    </div>

    <!-- Top Players Modal -->
    <div id="topPlayersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeTopPlayersModal()">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4">Select Top Players</h2>
            <div class="mb-4">
                <label class="text-gray-400 text-sm mb-2 block">Number of Top Players:</label>
                <select id="topPlayersCount" class="rounded px-4 py-2 text-sm w-full">
                    <option value="3">Top 3</option>
                    <option value="5">Top 5</option>
                    <option value="8">Top 8</option>
                    <option value="10">Top 10</option>
                    <option value="12">Top 12</option>
                    <option value="custom">Custom Selection</option>
                </select>
            </div>
            <div id="customSelectionDiv" style="display: none;">
                <p class="text-gray-400 text-sm mb-3">Select players to feature:</p>
                <div id="playerSelectionList" class="max-h-96 overflow-y-auto scrollbar-custom"></div>
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="applyTopPlayersSelection()" class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded text-sm flex-1">
                    APPLY
                </button>
                <button onclick="closeTopPlayersModal()" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">
                    CANCEL
                </button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let selectedTopPlayers = [];
        let randomTeams = [];
        let gameState = null;
        let teamsVisible = false;
        
        function getAPIBase() {
            if (window.location.hostname.includes('ngrok')) {
                return `${window.location.protocol}//${window.location.hostname}/api`;
            }
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:9000/api';
            }
            return `${window.location.protocol}//${window.location.hostname}/api`;
        }
        
        const API_BASE = getAPIBase();
        console.log('üîó API Base URL:', API_BASE);

        window.onload = async function() {
            await loadGameState();
            await loadPlayers();
        };

        async function loadGameState() {
            try {
                const response = await fetch(`${API_BASE}/gamestate`);
                const data = await response.json();
                
                if (data && data.active) {
                    gameState = data;
                    randomTeams = data.randomTeams || [];
                    selectedTopPlayers = data.selectedTopPlayers || [];
                    
                    console.log('‚úÖ Game state loaded from database');
                    console.log('Teams loaded:', randomTeams.length);
                }
            } catch (error) {
                console.error('Error loading game state:', error);
            }
        }

        async function saveGameState() {
            try {
                const stateData = {
                    active: randomTeams.length > 0,
                    randomTeams: randomTeams,
                    selectedTopPlayers: selectedTopPlayers,
                    lastUpdated: new Date().toISOString()
                };

                const response = await fetch(`${API_BASE}/gamestate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stateData)
                });

                const data = await response.json();
                gameState = data;
                console.log('‚úÖ Game state saved to database');
            } catch (error) {
                console.error('Error saving game state:', error);
                showAlert('Failed to save game state', 'error');
            }
        }

        function updateGameStatusUI() {
            const badge = document.getElementById('gameStatusBadge');
            const statusText = document.getElementById('gameStatusText');
            const endGameBtn = document.getElementById('endGameBtn');
            const randomTeamsBtn = document.getElementById('randomTeamsBtn');
            const viewTeamsBtn = document.getElementById('viewTeamsBtn');

            if (randomTeams.length > 0) {
                badge.className = 'game-status-badge game-status-active';
                statusText.innerHTML = '<span class="lock-icon">üéÆ</span> Game Active';
                viewTeamsBtn.style.display = 'block';
                endGameBtn.style.display = 'block';
                randomTeamsBtn.disabled = true;
            } else {
                badge.className = 'game-status-badge game-status-inactive';
                statusText.innerHTML = '<span class="lock-icon">üéÆ</span> No Active Game';
                endGameBtn.style.display = 'none';
                viewTeamsBtn.style.display = 'none';
                randomTeamsBtn.disabled = false;
            }
        }

        async function endGame() {
            const confirmed = confirm(
                '‚ö†Ô∏è End Current Game?\n\n' +
                'This will:\n' +
                '‚Ä¢ Clear all team assignments\n' +
                '‚Ä¢ Keep player scores intact\n\n' +
                'Continue?'
            );
            
            if (!confirmed) return;

            try {
                await fetch(`${API_BASE}/gamestate`, {
                    method: 'DELETE'
                });

                randomTeams = [];
                gameState = null;
                teamsVisible = false;

                displayRandomTeams();
                updateGameStatusUI();
                showAlert('Game ended successfully! Ready for new game üéÆ', 'success');
            } catch (error) {
                console.error('Error ending game:', error);
                showAlert('Failed to end game', 'error');
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE}/kills/getPlayers`);
                const data = await response.json();
                
                const playerDataMap = {};
                data.forEach(player => {
                    playerDataMap[player._id] = {
                        _id: player._id,
                        playerName: player.playerName,
                        ffName: player.ffName,
                        ffId: player.ffId,
                        map1: player.map1 || 0,
                        map2: player.map2 || 0,
                        map3: player.map3 || 0,
                        total: player.total || 0
                    };
                });
                
                if (randomTeams.length > 0 && gameState) {
                    console.log('üîÑ Preserving team structure from saved state...');
                    console.log('Number of teams loaded:', randomTeams.length);
                    
                    const preservedTeams = [];
                    
                    for (let teamIndex = 0; teamIndex < randomTeams.length; teamIndex++) {
                        const team = randomTeams[teamIndex];
                        const preservedTeam = [];
                        
                        console.log(`\n--- Team ${teamIndex + 1} ---`);
                        for (let playerIndex = 0; playerIndex < team.length; playerIndex++) {
                            const savedPlayer = team[playerIndex];
                            const updatedPlayer = playerDataMap[savedPlayer._id];
                            
                            if (updatedPlayer) {
                                console.log(`  Position ${playerIndex + 1}: ${updatedPlayer.playerName} (${updatedPlayer._id})`);
                                preservedTeam.push(updatedPlayer);
                            } else {
                                console.warn(`  Position ${playerIndex + 1}: Player not found in DB, using cached data`, savedPlayer);
                                preservedTeam.push(savedPlayer);
                            }
                        }
                        
                        preservedTeams.push(preservedTeam);
                    }
                    
                    randomTeams = preservedTeams;
                    
                    console.log('\n‚úÖ Teams preserved successfully!');
                    console.log('Final team structure:', randomTeams.map(t => t.map(p => p.playerName)));
                    
                    // Update players array to reflect the order in teams
                    const playersInTeams = [];
                    randomTeams.forEach(team => {
                        team.forEach(player => {
                            playersInTeams.push(player);
                        });
                    });
                    
                    // Add any players not in teams
                    const playerIdsInTeams = playersInTeams.map(p => p._id);
                    const playersNotInTeams = Object.values(playerDataMap).filter(
                        p => !playerIdsInTeams.includes(p._id)
                    );
                    
                    players = [...playersInTeams, ...playersNotInTeams];
                    
                    // Automatically show teams view on page load
                    teamsVisible = true;
                    updateGameStatusUI();
                    displayRandomTeams();
                    displayTopPlayers();
                    
                    // Update button text to show teams are visible
                    const viewTeamsBtn = document.getElementById('viewTeamsBtn');
                    if (viewTeamsBtn) {
                        viewTeamsBtn.innerHTML = 'üôà HIDE TEAMS';
                        viewTeamsBtn.className = 'btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded text-sm';
                    }
                } else {
                    console.log('No saved teams found, loading players only');
                    players = Object.values(playerDataMap);
                    teamsVisible = false;
                }
                
                sortAndRank();
                showAlert('Players loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading players:', error);
                showAlert('Failed to load players', 'error');
            }
        }

        function showTopPlayersModal() {
            if (players.length === 0) {
                showAlert('No players to select from', 'error');
                return;
            }
            
            const modal = document.getElementById('topPlayersModal');
            const select = document.getElementById('topPlayersCount');
            
            select.onchange = function() {
                if (this.value === 'custom') {
                    document.getElementById('customSelectionDiv').style.display = 'block';
                    renderPlayerSelectionList();
                } else {
                    document.getElementById('customSelectionDiv').style.display = 'none';
                }
            };
            
            modal.style.display = 'block';
        }

        function closeTopPlayersModal() {
            document.getElementById('topPlayersModal').style.display = 'none';
        }

        function renderPlayerSelectionList() {
            const container = document.getElementById('playerSelectionList');
            container.innerHTML = players.map((player, index) => `
                <label class="flex items-center p-3 hover:bg-white/5 cursor-pointer rounded mb-2">
                    <input type="checkbox" class="checkbox-player" value="${player._id}" 
                        ${selectedTopPlayers.includes(player._id) ? 'checked' : ''}>
                    <span class="text-white font-semibold">${index + 1}. ${player.playerName}</span>
                    <span class="text-gray-400 ml-2">(${player.total} kills)</span>
                </label>
            `).join('');
        }

        async function applyTopPlayersSelection() {
            const select = document.getElementById('topPlayersCount');
            
            if (select.value === 'custom') {
                const checkboxes = document.querySelectorAll('.checkbox-player:checked');
                selectedTopPlayers = Array.from(checkboxes).map(cb => cb.value);
            } else {
                const count = parseInt(select.value);
                selectedTopPlayers = players.slice(0, count).map(p => p._id);
            }
            
            displayTopPlayers();
            closeTopPlayersModal();
            
            if (gameState) {
                await saveGameState();
            }
        }

        function getPlayerTeamInfo(playerId) {
            const TEAMS_PER_ROOM = 12;
            
            for (let i = 0; i < randomTeams.length; i++) {
                const team = randomTeams[i];
                const playerInTeam = team.find(p => p._id === playerId);
                
                if (playerInTeam) {
                    const roomNumber = Math.floor(i / TEAMS_PER_ROOM) + 1;
                    const teamNumber = i + 1;
                    return { room: roomNumber, team: teamNumber };
                }
            }
            
            return null;
        }

        function displayTopPlayers() {
            const section = document.getElementById('topPlayersSection');
            const container = document.getElementById('topPlayersContainer');
            
            if (selectedTopPlayers.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            const topPlayers = players.filter(p => selectedTopPlayers.includes(p._id));
            
            container.innerHTML = topPlayers.map((player) => {
                const rank = players.indexOf(player) + 1;
                const teamInfo = getPlayerTeamInfo(player._id);
                
                return `
                    <div class="top-player-card">
                        <div class="text-4xl font-black text-yellow-400 mb-2">#${rank}</div>
                        <div class="text-lg font-bold text-white mb-1">${player.playerName}</div>
                        <div class="text-sm text-gray-400 mb-2">${player.ffName}</div>
                        ${teamInfo ? `
                            <div class="text-xs font-bold text-blue-400 mb-2">
                                Room ${teamInfo.room} ‚Ä¢ Team ${teamInfo.team}
                            </div>
                        ` : ''}
                        <div class="text-2xl font-bold text-orange-500">${player.total} Kills</div>
                    </div>
                `;
            }).join('');
            
            section.style.display = 'block';
        }

        function toggleTeamsView() {
            const section = document.getElementById('randomTeamsSection');
            const viewTeamsBtn = document.getElementById('viewTeamsBtn');
            
            if (teamsVisible) {
                section.style.display = 'none';
                viewTeamsBtn.innerHTML = 'üëÅÔ∏è VIEW TEAMS';
                viewTeamsBtn.className = 'btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded text-sm';
                teamsVisible = false;
            } else {
                displayRandomTeams();
                viewTeamsBtn.innerHTML = 'üôà HIDE TEAMS';
                viewTeamsBtn.className = 'btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded text-sm';
                teamsVisible = true;
            }
        }

        async function generateRandomTeams() {
            if (players.length === 0) {
                showAlert('No players to create teams', 'error');
                return;
            }

            if (randomTeams.length > 0) {
                showAlert('Teams already created! End the current game first to create new teams.', 'error');
                return;
            }

            const shuffled = [...players].sort(() => Math.random() - 0.5);
            
            randomTeams = [];
            for (let i = 0; i < shuffled.length; i += 4) {
                randomTeams.push(shuffled.slice(i, i + 4));
            }
            
            await saveGameState();
            teamsVisible = true;
            displayRandomTeams();
            displayTopPlayers();
            updateGameStatusUI();
            
            showAlert(`Created ${randomTeams.length} random teams!`, 'success');
        }

        function displayRandomTeams() {
            const section = document.getElementById('randomTeamsSection');
            const container = document.getElementById('randomTeamsContainer');
            const viewTeamsBtn = document.getElementById('viewTeamsBtn');
            
            if (randomTeams.length === 0) {
                section.style.display = 'none';
                teamsVisible = false;
                return;
            }
            
            if (teamsVisible) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
            
            if (viewTeamsBtn) {
                viewTeamsBtn.innerHTML = teamsVisible ? 'üôà HIDE TEAMS' : 'üëÅÔ∏è VIEW TEAMS';
                viewTeamsBtn.className = teamsVisible 
                    ? 'btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded text-sm'
                    : 'btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded text-sm';
            }
            
            if (!teamsVisible) {
                return;
            }
            
            const teamColors = [
                'rgba(59, 130, 246, 0.15)', 'rgba(16, 185, 129, 0.15)', 
                'rgba(249, 115, 22, 0.15)', 'rgba(236, 72, 153, 0.15)',
                'rgba(168, 85, 247, 0.15)', 'rgba(245, 158, 11, 0.15)', 
                'rgba(20, 184, 166, 0.15)', 'rgba(239, 68, 68, 0.15)',
            ];
            
            const borderColors = [
                '#3b82f6', '#10b981', '#f97316', '#ec4899',
                '#a855f7', '#f59e0b', '#14b8a6', '#ef4444'
            ];
            
            const TEAMS_PER_ROOM = 12;
            const rooms = [];
            for (let i = 0; i < randomTeams.length; i += TEAMS_PER_ROOM) {
                rooms.push(randomTeams.slice(i, i + TEAMS_PER_ROOM));
            }
            
            container.innerHTML = rooms.map((roomTeams, roomIndex) => {
                const roomNumber = roomIndex + 1;
                const totalRoomKills = roomTeams.reduce((sum, team) => sum + team.reduce((tSum, p) => tSum + p.total, 0), 0);
                
                return `
                    <div class="card rounded-lg p-5 mb-6 shadow-xl">
                        <div class="flex items-center justify-between mb-5 pb-4 border-b border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
                                    <span class="text-2xl font-black text-white">${roomNumber}</span>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">Room ${roomNumber}</h3>
                                    <p class="text-gray-400 text-sm">${roomTeams.length} Teams ‚Ä¢ ${roomTeams.reduce((sum, t) => sum + t.length, 0)} Players</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-orange-500">${totalRoomKills}</div>
                                <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${roomTeams.map((team, teamIndex) => {
                                const globalTeamIndex = roomIndex * TEAMS_PER_ROOM + teamIndex;
                                const bgColor = teamColors[globalTeamIndex % teamColors.length];
                                const borderColor = borderColors[globalTeamIndex % borderColors.length];
                                
                                return `
                                    <div class="card rounded-lg overflow-hidden" style="background: ${bgColor}; border-color: ${borderColor};">
                                        <div class="flex items-center justify-between p-4 border-b" style="border-color: ${borderColor}40;">
                                            <h4 class="text-lg font-bold text-white">Team ${globalTeamIndex + 1}</h4>
                                            <div class="flex items-center gap-3">
                                                <span class="px-2 py-1 rounded text-xs font-bold" style="background: ${borderColor}30; color: ${borderColor};">
                                                    ${team.length} ${team.length === 1 ? 'Player' : 'Players'}
                                                </span>
                                                <span class="text-orange-500 font-bold">
                                                    ${team.reduce((sum, p) => sum + p.total, 0)} kills
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm">
                                                <thead>
                                                    <tr style="background: rgba(0,0,0,0.2);">
                                                        <th class="p-2 text-left text-gray-300 font-bold uppercase text-xs">Player</th>
                                                        <th class="p-2 text-left text-gray-300 font-bold uppercase text-xs">FF Name</th>
                                                        <th class="p-2 text-center text-gray-300 font-bold uppercase text-xs">B</th>
                                                        <th class="p-2 text-center text-gray-300 font-bold uppercase text-xs">P</th>
                                                        <th class="p-2 text-center text-gray-300 font-bold uppercase text-xs">K</th>
                                                        <th class="p-2 text-center text-orange-400 font-bold uppercase text-xs">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${team.map((player) => `
                                                        <tr class="border-t" style="border-color: ${borderColor}20;">
                                                            <td class="p-2 text-white font-semibold text-xs">${player.playerName}</td>
                                                            <td class="p-2 text-gray-300 text-xs">${player.ffName}</td>
                                                            <td class="p-2 text-center">
                                                                <input type="number" value="${player.map1}" min="0" 
                                                                    onchange="updateTeamKills('${player._id}', 'map1', this.value)"
                                                                    class="w-12 rounded px-1 py-1 text-center font-semibold text-xs">
                                                            </td>
                                                            <td class="p-2 text-center">
                                                                <input type="number" value="${player.map2}" min="0" 
                                                                    onchange="updateTeamKills('${player._id}', 'map2', this.value)"
                                                                    class="w-12 rounded px-1 py-1 text-center font-semibold text-xs">
                                                            </td>
                                                            <td class="p-2 text-center">
                                                                <input type="number" value="${player.map3}" min="0" 
                                                                    onchange="updateTeamKills('${player._id}', 'map3', this.value)"
                                                                    class="w-12 rounded px-1 py-1 text-center font-semibold text-xs">
                                                            </td>
                                                            <td class="p-2 text-center">
                                                                <span class="text-orange-500 font-bold">${player.total}</span>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            section.style.display = 'block';
        }

        function updateStats() {
            const totalPlayers = players.length;
            const totalKills = players.reduce((sum, p) => sum + p.total, 0);

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalKills').textContent = totalKills;
        }

        async function deletePlayer(id) {
            if (confirm('Delete this player?')) {
                try {
                    const response = await fetch(`${API_BASE}/kills/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        selectedTopPlayers = selectedTopPlayers.filter(pid => pid !== id);
                        loadPlayers();
                        displayTopPlayers();
                        showAlert('Player deleted', 'success');
                    } else {
                        throw new Error('Failed to delete player');
                    }
                } catch (error) {
                    showAlert('Error: ' + error.message, 'error');
                }
            }
        }

        async function updateKills(id, map, value) {
            const player = players.find(p => p._id === id);
            if (!player) return;

            player[map] = parseInt(value) || 0;
            player.total = player.map1 + player.map2 + player.map3;

            try {
                await fetch(`${API_BASE}/kills/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        map1: player.map1,
                        map2: player.map2,
                        map3: player.map3
                    })
                });

                displayRandomTeams();
                sortAndRank();
                displayTopPlayers();
                
                if (gameState) {
                    await saveGameState();
                }
            } catch (error) {
                console.error('Error updating kills:', error);
                showAlert('Failed to update kills', 'error');
            }
        }

        async function updateTeamKills(id, map, value) {
            const player = players.find(p => p._id === id);
            if (!player) return;

            player[map] = parseInt(value) || 0;
            player.total = player.map1 + player.map2 + player.map3;

            try {
                await fetch(`${API_BASE}/kills/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        map1: player.map1,
                        map2: player.map2,
                        map3: player.map3
                    })
                });

                displayRandomTeams();
                sortAndRank();
                displayTopPlayers();
                
                if (gameState) {
                    await saveGameState();
                }
            } catch (error) {
                console.error('Error updating kills:', error);
                showAlert('Failed to update kills', 'error');
            }
        }

        function sortAndRank() {
            players.sort((a, b) => b.total - a.total);
            renderTable();
            updateStats();
        }

        function renderTable() {
            const tbody = document.getElementById('scoreTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (players.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = players.map((player, index) => {
                const rank = index + 1;
                const isTop48 = rank <= 48;
                const isTop3 = rank <= 3;
                const rowClass = isTop48 ? 'top-player accent-border' : 'accent-border';
                const isSelected = selectedTopPlayers.includes(player._id);
                
                return `
                    <tr class="${rowClass} border-b border-gray-800">
                        <td class="p-4 text-center">
                            <input type="checkbox" class="checkbox-player" ${isSelected ? 'checked' : ''} 
                                onchange="toggleTopPlayerSelection('${player._id}', this.checked)">
                        </td>
                        <td class="p-4">
                            <div class="rank-badge ${isTop3 ? 'top-3' : ''} rounded">${rank}</div>
                        </td>
                        <td class="p-4 font-semibold">${player.playerName}</td>
                        <td class="p-4 text-gray-300">${player.ffName}</td>
                        <td class="p-4 text-gray-400 font-mono text-xs">${player.ffId}</td>
                        <td class="p-4 text-center">
                            <input type="number" value="${player.map1}" min="0" 
                                onchange="updateKills('${player._id}', 'map1', this.value)"
                                class="w-16 rounded px-2 py-1 text-center font-semibold text-sm" readonly>
                        </td>
                        <td class="p-4 text-center">
                            <input type="number" value="${player.map2}" min="0" 
                                onchange="updateKills('${player._id}', 'map2', this.value)"
                                class="w-16 rounded px-2 py-1 text-center font-semibold text-sm" readonly>
                        </td>
                        <td class="p-4 text-center">
                            <input type="number" value="${player.map3}" min="0" 
                                onchange="updateKills('${player._id}', 'map3', this.value)"
                                class="w-16 rounded px-2 py-1 text-center font-semibold text-sm" readonly>
                        </td>
                        <td class="p-4 text-center">
                            <span class="text-xl font-bold text-orange-500">${player.total}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="deletePlayer('${player._id}')" 
                                class="delete-btn text-gray-400 hover:text-red-500 font-bold text-lg">
                                ‚úï
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function toggleTopPlayerSelection(playerId, checked) {
            if (checked) {
                if (!selectedTopPlayers.includes(playerId)) {
                    selectedTopPlayers.push(playerId);
                }
            } else {
                selectedTopPlayers = selectedTopPlayers.filter(id => id !== playerId);
            }
            displayTopPlayers();
            
            if (gameState) {
                await saveGameState();
            }
        }

        function exportXLSX(format) {
            if (players.length === 0) {
                showAlert('No data to export', 'error');
                return;
            }

            closeExportModal();

            if (format === 'singles') {
                exportSingles();
            } else if (format === 'squads') {
                if (randomTeams.length === 0) {
                    showAlert('No squads created. Please generate random teams first!', 'error');
                    return;
                }
                exportSquads();
            } else if (format === 'both') {
                exportBoth();
            }
        }

        function exportSingles() {
            const data = players.map((p, i) => ({
                'Rank': i + 1,
                'Player Name': p.playerName,
                'FF Name': p.ffName,
                'FF ID': p.ffId,
                'Bermuda': p.map1,
                'Purgatory': p.map2,
                'Kalahari': p.map3,
                'Total Kills': p.total
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            
            ws['!cols'] = [
                {wch: 8}, {wch: 20}, {wch: 20}, {wch: 15},
                {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Singles");
            XLSX.writeFile(wb, `FreeFire_Singles_${new Date().toISOString().split('T')[0]}.xlsx`);
            showAlert('Singles exported successfully!', 'success');
        }

        function exportSquads() {
            const data = [];
            const TEAMS_PER_ROOM = 12;
            
            randomTeams.forEach((team, teamIndex) => {
                const roomNumber = Math.floor(teamIndex / TEAMS_PER_ROOM) + 1;
                const teamNumber = teamIndex + 1;
                const teamTotalKills = team.reduce((sum, p) => sum + p.total, 0);
                
                data.push({
                    'Room': `Room ${roomNumber}`,
                    'Team': `Team ${teamNumber}`,
                    'Player Name': '',
                    'FF Name': '',
                    'FF ID': '',
                    'Bermuda': '',
                    'Purgatory': '',
                    'Kalahari': '',
                    'Total': teamTotalKills
                });
                
                team.forEach((player) => {
                    data.push({
                        'Room': '',
                        'Team': '',
                        'Player Name': player.playerName,
                        'FF Name': player.ffName,
                        'FF ID': player.ffId,
                        'Bermuda': player.map1,
                        'Purgatory': player.map2,
                        'Kalahari': player.map3,
                        'Total': player.total
                    });
                });
                
                data.push({
                    'Room': '', 'Team': '', 'Player Name': '', 'FF Name': '', 'FF ID': '',
                    'Bermuda': '', 'Purgatory': '', 'Kalahari': '', 'Total': ''
                });
            });

            const ws = XLSX.utils.json_to_sheet(data);
            
            ws['!cols'] = [
                {wch: 12}, {wch: 12}, {wch: 20}, {wch: 20}, {wch: 15},
                {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Squads");
            XLSX.writeFile(wb, `FreeFire_Squads_${new Date().toISOString().split('T')[0]}.xlsx`);
            showAlert('Squads exported successfully!', 'success');
        }

        function exportBoth() {
            const wb = XLSX.utils.book_new();
            
            const singlesData = players.map((p, i) => ({
                'Rank': i + 1,
                'Player Name': p.playerName,
                'FF Name': p.ffName,
                'FF ID': p.ffId,
                'Bermuda': p.map1,
                'Purgatory': p.map2,
                'Kalahari': p.map3,
                'Total Kills': p.total
            }));
            const singlesWs = XLSX.utils.json_to_sheet(singlesData);
            singlesWs['!cols'] = [
                {wch: 8}, {wch: 20}, {wch: 20}, {wch: 15},
                {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}
            ];
            XLSX.utils.book_append_sheet(wb, singlesWs, "Singles");
            
            if (randomTeams.length > 0) {
                const squadsData = [];
                const TEAMS_PER_ROOM = 12;
                
                randomTeams.forEach((team, teamIndex) => {
                    const roomNumber = Math.floor(teamIndex / TEAMS_PER_ROOM) + 1;
                    const teamNumber = teamIndex + 1;
                    const teamTotalKills = team.reduce((sum, p) => sum + p.total, 0);
                    
                    squadsData.push({
                        'Room': `Room ${roomNumber}`,
                        'Team': `Team ${teamNumber}`,
                        'Player Name': '',
                        'FF Name': '',
                        'FF ID': '',
                        'Bermuda': '',
                        'Purgatory': '',
                        'Kalahari': '',
                        'Total': teamTotalKills
                    });
                    
                    team.forEach((player) => {
                        squadsData.push({
                            'Room': '',
                            'Team': '',
                            'Player Name': player.playerName,
                            'FF Name': player.ffName,
                            'FF ID': player.ffId,
                            'Bermuda': player.map1,
                            'Purgatory': player.map2,
                            'Kalahari': player.map3,
                            'Total': player.total
                        });
                    });
                    
                    squadsData.push({
                        'Room': '', 'Team': '', 'Player Name': '', 'FF Name': '', 'FF ID': '',
                        'Bermuda': '', 'Purgatory': '', 'Kalahari': '', 'Total': ''
                    });
                });
                
                const squadsWs = XLSX.utils.json_to_sheet(squadsData);
                squadsWs['!cols'] = [
                    {wch: 12}, {wch: 12}, {wch: 20}, {wch: 20}, {wch: 15},
                    {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}
                ];
                XLSX.utils.book_append_sheet(wb, squadsWs, "Squads");
            }
            
            XLSX.writeFile(wb, `FreeFire_Complete_${new Date().toISOString().split('T')[0]}.xlsx`);
            showAlert('Complete export successful!', 'success');
        }

        function showExportModal() {
            if (players.length === 0) {
                showAlert('No data to export', 'error');
                return;
            }
            
            const modal = document.getElementById('exportModal');
            const squadsBtn = document.getElementById('exportSquadsBtn');
            
            if (randomTeams.length === 0) {
                squadsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                squadsBtn.disabled = true;
            } else {
                squadsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                squadsBtn.disabled = false;
            }
            
            modal.style.display = 'block';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        async function clearAllData() {
            const confirmed = confirm(
                '‚ö†Ô∏è CLEAR ALL DATA?\n\n' +
                'This will PERMANENTLY delete:\n' +
                '‚Ä¢ All players\n' +
                '‚Ä¢ All teams\n' +
                '‚Ä¢ All scores\n' +
                '‚Ä¢ Game state\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Type "DELETE" to confirm'
            );
            
            if (!confirmed) return;

            const verification = prompt('Type DELETE to confirm:');
            if (verification !== 'DELETE') {
                showAlert('Deletion cancelled', 'warning');
                return;
            }

            try {
                await fetch(`${API_BASE}/kills/deleteAll`, {
                    method: 'DELETE'
                });

                await fetch(`${API_BASE}/gamestate`, {
                    method: 'DELETE'
                });

                players = [];
                randomTeams = [];
                selectedTopPlayers = [];
                gameState = null;
                teamsVisible = false;

                renderTable();
                updateStats();
                displayRandomTeams();
                displayTopPlayers();
                updateGameStatusUI();

                showAlert('All data cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing data:', error);
                showAlert('Failed to clear data', 'error');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>