<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fire Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Exo+2:wght@400;600;700;800&display=swap');
        
        * {
            font-family: 'Exo 2', sans-serif;
        }
        
        body {
            background: #0b0e17;
            position: relative;
            overflow-x: hidden;
        }
        
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(180deg, #0b0e17 0%, #1a1d2e 50%, #0b0e17 100%);
        }
        
        .content {
            position: relative;
            z-index: 1;
        }
        
        .card {
            background: rgba(20, 24, 38, 0.95);
            border: 1px solid rgba(255, 68, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .accent-border {
            border-left: 3px solid #ff4400;
        }
        
        .top-player {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.08), transparent);
            border-left: 3px solid #ffd700;
        }
        
        input[type="text"], input[type="number"], select {
            background: rgba(30, 35, 50, 0.8);
            border: 1px solid rgba(255, 68, 0, 0.2);
            color: #fff;
            transition: all 0.2s ease;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #ff4400;
            background: rgba(30, 35, 50, 1);
        }
        
        .btn {
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 0 8px;
            background: rgba(255, 68, 0, 0.1);
            border: 1px solid rgba(255, 68, 0, 0.3);
            color: #ff6633;
            font-weight: 700;
            font-size: 14px;
        }
        
        .rank-badge.top-3 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
            border-color: #ffd700;
            color: #ffd700;
            font-weight: 800;
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(30, 35, 50, 0.5);
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(255, 68, 0, 0.4);
            border-radius: 4px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 68, 0, 0.6);
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        thead th {
            position: sticky;
            top: 0;
            background: rgba(20, 24, 38, 0.98);
            z-index: 10;
        }
        
        tbody tr {
            transition: background 0.15s ease;
        }
        
        tbody tr:hover {
            background: rgba(255, 68, 0, 0.05);
        }
        
        .stat-item {
            background: rgba(30, 35, 50, 0.6);
            border: 1px solid rgba(255, 68, 0, 0.15);
        }
        
        .delete-btn {
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            opacity: 1;
            color: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: rgba(20, 24, 38, 0.98);
            margin: 5% auto;
            padding: 30px;
            border: 2px solid rgba(255, 68, 0, 0.3);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #ff4400;
        }

        .top-players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .top-player-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .checkbox-player {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background: #10b981;
        }

        .alert-error {
            background: #ef4444;
        }

        .alert-warning {
            background: #f59e0b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .scoreboard-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: 2px solid #10b981;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .scoreboard-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669, #047857);
        }

        .room-nav-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 2px solid rgba(139, 92, 246, 0.3);
            background: rgba(30, 35, 50, 0.8);
            color: #fff;
            cursor: pointer;
        }

        .room-nav-btn:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .room-nav-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-color: #8b5cf6;
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .squad-card {
            background: rgba(30, 35, 50, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .squad-card:hover {
            background: rgba(30, 35, 50, 0.95);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .search-box {
            background: rgba(30, 35, 50, 0.8);
            border: 1px solid rgba(255, 68, 0, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            transition: all 0.2s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff4400;
            background: rgba(30, 35, 50, 1);
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <div class="content p-4 md:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card rounded-lg p-6 mb-6 shadow-xl">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white mb-1">
                            <span class="text-orange-500">ADMIN PANEL</span>
                        </h1>
                        <p class="text-gray-400 text-sm font-medium">Tournament Management & Score Entry</p>
                    </div>
                    
                    <!-- Stats & Links -->
                    <div class="flex gap-4 items-center flex-wrap">
                        <a href="/scoreboard" target="_blank" class="scoreboard-link">
                            <span>üì∫</span>
                            <span>INDIVIDUAL SCOREBOARD</span>
                        </a>
                        <a href="/squadscoreboard" target="_blank" class="scoreboard-link" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-color: #8b5cf6; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                            <span>üõ°Ô∏è</span>
                            <span>SQUAD SCOREBOARD</span>
                        </a>
                        <div class="stat-item rounded px-4 py-2">
                            <div class="text-2xl font-bold text-white" id="totalPlayers">0</div>
                            <div class="text-xs text-gray-400 uppercase">Individual</div>
                        </div>
                        <div class="stat-item rounded px-4 py-2">
                            <div class="text-2xl font-bold text-purple-500" id="totalSquads">0</div>
                            <div class="text-xs text-gray-400 uppercase">Squads</div>
                        </div>
                        <div class="stat-item rounded px-4 py-2">
                            <div class="text-2xl font-bold text-cyan-500" id="totalRooms">0</div>
                            <div class="text-xs text-gray-400 uppercase">Rooms</div>
                        </div>
                        <div class="stat-item rounded px-4 py-2">
                            <div class="text-2xl font-bold text-orange-500" id="totalKills">0</div>
                            <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="card rounded-lg p-5 mb-6 shadow-xl">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <button onclick="showTopPlayersModal()" class="btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded text-sm">
                        ‚≠ê TOP PLAYERS
                    </button>
                    <button onclick="testBackendConnection()" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded text-sm">
                        üîå TEST CONNECTION
                    </button>
                    <button onclick="loadData()" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded text-sm">
                        üîÑ REFRESH
                    </button>
                    <button onclick="showExportModal()" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded text-sm">
                        üì§ EXPORT
                    </button>
                    <button onclick="clearAllData()" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded text-sm">
                        üóëÔ∏è CLEAR ALL
                    </button>
                </div>
            </div>

            <!-- Top Players Section -->
            <div id="topPlayersSection" class="card rounded-lg p-5 mb-6 shadow-xl" style="display: none;">
                <h2 class="text-2xl font-bold text-white mb-4">üèÜ TOP PLAYERS</h2>
                <div id="topPlayersContainer" class="top-players-grid"></div>
            </div>

            <!-- Search Section -->
            <div class="card rounded-lg p-5 mb-6 shadow-xl">
                <h2 class="text-xl font-bold text-white mb-4">üîç SEARCH SQUADS</h2>
                <input 
                    type="text" 
                    id="searchBox" 
                    class="search-box w-full" 
                    placeholder="Search by squad name, player name, or FF ID..."
                    oninput="searchSquads()"
                >
            </div>

            <!-- Room Navigation -->
            <div id="roomNavigationSection" class="card rounded-lg p-5 mb-6 shadow-xl">
                <h2 class="text-xl font-bold text-white mb-4">üéÆ ROOM NAVIGATION</h2>
                <div id="roomNavButtons" class="flex flex-wrap gap-3">
                    <button onclick="switchRoom('all')" class="room-nav-btn active" id="roomBtn-all">
                        üìã ALL ROOMS
                    </button>
                </div>
            </div>

            <!-- Squads by Room -->
            <div id="squadsSection">
                <!-- Rooms will be rendered here -->
            </div>

            <!-- Individual Players Score Table -->
            <div class="card rounded-lg shadow-xl overflow-hidden mb-6">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="text-xl font-bold text-white">üë§ INDIVIDUAL PLAYERS - SCORE ENTRY</h2>
                    <p class="text-gray-400 text-sm mt-1">Enter kills for individual players</p>
                </div>
                <div class="overflow-x-auto scrollbar-custom" style="max-height: 70vh;">
                    <table class="w-full text-left text-sm">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">Select</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">Rank</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">Player Name</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">FF Name</th>
                                <th class="p-4 text-gray-400 font-bold uppercase text-xs">FF ID</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Bermuda</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Purgatory</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Kalahari</th>
                                <th class="p-4 text-center text-orange-500 font-bold uppercase text-xs">Total</th>
                                <th class="p-4 text-center text-gray-400 font-bold uppercase text-xs">Action</th>
                            </tr>
                        </thead>
                        <tbody id="scoreTableBody" class="text-white">
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyState" class="text-center py-20">
                    <div class="text-gray-600 text-5xl mb-4">üìä</div>
                    <p class="text-gray-400 text-lg font-semibold">No Individual Players</p>
                    <p class="text-gray-500 text-sm mt-2">Individual players will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
   <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeExportModal()">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4">üì§ Export Options</h2>
            <p class="text-gray-400 text-sm mb-4">Choose your export format:</p>

            <div class="space-y-3">
                <!-- Individual Players Export -->
                <div class="border-b border-gray-700 pb-3">
                    <p class="text-white font-semibold mb-2 text-sm">üìä INDIVIDUAL PLAYERS</p>
                    <div class="space-y-2">
                        <button onclick="exportXLSX('singles')"
                            class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                            Export All Individual Players
                        </button>
                        <button onclick="exportXLSX('top48')"
                            class="btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                            üèÜ Export Top 48 Players
                        </button>
                    </div>
                </div>

                <!-- Squads Export -->
                <div class="border-b border-gray-700 pb-3">
                    <p class="text-white font-semibold mb-2 text-sm">üõ°Ô∏è SQUADS</p>
                    <button onclick="exportXLSX('squads')"
                        class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                        Export All Squads
                    </button>
                </div>

                <!-- Rooms Export -->
                <div class="border-b border-gray-700 pb-3">
                    <p class="text-white font-semibold mb-2 text-sm">üéÆ ROOMS</p>
                    <button onclick="exportXLSX('rooms')"
                        class="btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                        Export by Rooms (Separate Sheets)
                    </button>
                </div>

                <!-- Complete Export -->
                <div class="pb-3">
                    <p class="text-white font-semibold mb-2 text-sm">üìë COMPLETE PACKAGE</p>
                    <button onclick="exportXLSX('complete')"
                        class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded text-sm w-full">
                        Export Everything
                    </button>
                </div>
            </div>

            <button onclick="closeExportModal()"
                class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm w-full mt-4">
                CANCEL
            </button>
        </div>
    </div>

    <!-- Top Players Modal -->
    <div id="topPlayersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeTopPlayersModal()">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4">Select Top Players</h2>
            <div class="mb-4">
                <label class="text-gray-400 text-sm mb-2 block">Number of Top Players:</label>
                <select id="topPlayersCount" class="rounded px-4 py-2 text-sm w-full">
                    <option value="3">Top 3</option>
                    <option value="5">Top 5</option>
                    <option value="8">Top 8</option>
                    <option value="10">Top 10</option>
                    <option value="12">Top 12</option>
                    <option value="48">Top 48</option>
                    <option value="custom">Custom Selection</option>
                </select>
            </div>
            <div id="customSelectionDiv" style="display: none;">
                <p class="text-gray-400 text-sm mb-3">Select players to feature:</p>
                <div id="playerSelectionList" class="max-h-96 overflow-y-auto scrollbar-custom"></div>
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="applyTopPlayersSelection()" class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded text-sm flex-1">
                    APPLY
                </button>
                <button onclick="closeTopPlayersModal()" class="btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">
                    CANCEL
                </button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let squads = [];
        let rooms = [];
        let selectedTopPlayers = [];
        let currentRoom = 'all';
        let gameState = null;
        const SQUADS_PER_ROOM = 12;
        
        function getAPIBase() {
            if (window.location.hostname.includes('ngrok')) {
                return `${window.location.protocol}//${window.location.hostname}/api`;
            }
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:9000/api';
            }
            return `${window.location.protocol}//${window.location.hostname}/api`;
        }
        
        const API_BASE = getAPIBase();
        console.log('üîó API Base URL:', API_BASE);

        // Test backend connection
        async function testBackendConnection() {
            console.log('üß™ Testing backend connection...');
            showAlert('Testing backend connection...', 'warning');
            
            try {
                // Test 1: Get Players
                console.log('Test 1: GET /kills/getPlayers');
                const playersRes = await fetch(`${API_BASE}/kills/getPlayers`);
                console.log('Players response:', playersRes.status, playersRes.ok);
                
                // Test 2: Get Squads
                console.log('Test 2: GET /kills/getSquads');
                const squadsRes = await fetch(`${API_BASE}/kills/getSquads`);
                console.log('Squads response:', squadsRes.status, squadsRes.ok);
                
                // Test 3: Check if update endpoint exists
                console.log('Test 3: Check update endpoint structure');
                console.log('Update URL would be:', `${API_BASE}/kills/updateSquadPlayerKills`);
                
                if (playersRes.ok && squadsRes.ok) {
                    const squadsData = await squadsRes.json();
                    const squadsList = Array.isArray(squadsData) ? squadsData : (squadsData.squads || []);
                    
                    console.log('‚úÖ Backend connection successful!');
                    console.log(`Found ${squadsList.length} squads`);
                    
                    // Check if squads have kill tracking fields
                    if (squadsList.length > 0) {
                        const firstSquad = squadsList[0];
                        const hasKillFields = firstSquad.players[0]?.hasOwnProperty('map1');
                        
                        if (hasKillFields) {
                            console.log('‚úÖ Squad schema includes kill tracking fields');
                            showAlert('‚úÖ Backend connected! Kill tracking ready.', 'success');
                        } else {
                            console.warn('‚ö†Ô∏è Squad schema missing kill tracking fields');
                            showAlert('‚ö†Ô∏è Backend connected but squad schema needs update', 'warning');
                        }
                    } else {
                        showAlert('‚úÖ Backend connected! No squads registered yet.', 'success');
                    }
                } else {
                    throw new Error('Backend endpoints not responding correctly');
                }
                
            } catch (error) {
                console.error('‚ùå Backend connection test failed:', error);
                showAlert(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        window.onload = async function() {
            await loadGameState();
            await loadData();
        };

        async function loadGameState() {
            try {
                const response = await fetch(`${API_BASE}/gamestate`);
                const data = await response.json();
                
                if (data && data.squads) {
                    gameState = data;
                    selectedTopPlayers = data.selectedTopPlayers || [];
                    console.log('‚úÖ Game state loaded from database');
                }
            } catch (error) {
                console.error('Error loading game state:', error);
            }
        }

        async function saveGameState() {
            try {
                const stateData = {
                    squads: squads,
                    selectedTopPlayers: selectedTopPlayers,
                    lastUpdated: new Date().toISOString()
                };

                const response = await fetch(`${API_BASE}/gamestate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stateData)
                });

                const data = await response.json();
                gameState = data;
                console.log('‚úÖ Game state saved to database');
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        async function loadData() {
            await Promise.all([loadPlayers(), loadSquads()]);
            showAlert('Data loaded successfully!', 'success');
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE}/kills/getPlayers`);
                const data = await response.json();
                
                players = data.map(player => ({
                    _id: player._id,
                    playerName: player.playerName,
                    ffName: player.ffName,
                    ffId: player.ffId,
                    map1: player.map1 || 0,
                    map2: player.map2 || 0,
                    map3: player.map3 || 0,
                    total: player.total || 0
                }));
                
                sortAndRank();
                console.log(`‚úÖ Loaded ${players.length} individual players`);
            } catch (error) {
                console.error('‚ùå Error loading players:', error);
                showAlert('Failed to load players', 'error');
            }
        }

        async function loadSquads() {
            try {
                const response = await fetch(`${API_BASE}/kills/getSquads`);
                const data = await response.json();
                
                squads = Array.isArray(data) ? data : (data.squads || []);
                
                // Add kill tracking to each player in squad if not present
                squads = squads.map(squad => ({
                    ...squad,
                    players: squad.players.map(player => ({
                        ...player,
                        map1: player.map1 || 0,
                        map2: player.map2 || 0,
                        map3: player.map3 || 0,
                        total: player.total || 0
                    }))
                }));
                
                organizeRooms();
                renderRoomNavigation();
                renderSquads();
                updateStats();
                
                console.log(`‚úÖ Loaded ${squads.length} squads organized into ${rooms.length} rooms`);
            } catch (error) {
                console.error('‚ùå Error loading squads:', error);
                showAlert('Failed to load squads', 'error');
            }
        }

       function organizeRooms() {
    // Group squads by their actual room field from database
    const roomMap = {};
    
    squads.forEach(squad => {
        const roomName = squad.room || 'Unassigned';
        if (!roomMap[roomName]) {
            roomMap[roomName] = [];
        }
        roomMap[roomName].push(squad);
    });
    
    // Convert to rooms array format
    rooms = Object.entries(roomMap)
        .filter(([roomName]) => roomName !== 'Unassigned')
        .sort((a, b) => {
            // Extract room number from "Room 1", "Room 2", etc.
            const aNum = parseInt(a[0].replace(/\D/g, '')) || 0;
            const bNum = parseInt(b[0].replace(/\D/g, '')) || 0;
            return aNum - bNum;
        })
        .map(([roomName, roomSquads], index) => ({
            roomNumber: index + 1,
            roomName: roomName,
            squads: roomSquads
        }));
    
    console.log('üìã Organized rooms:', rooms.map(r => `${r.roomName}: ${r.squads.length} squads`));
}

        function renderRoomNavigation() {
            const navButtons = document.getElementById('roomNavButtons');
            
            if (rooms.length === 0) {
                navButtons.innerHTML = '<div class="text-gray-400">No rooms available</div>';
                return;
            }
            
            navButtons.innerHTML = `
                <button onclick="switchRoom('all')" 
                    class="room-nav-btn ${currentRoom === 'all' ? 'active' : ''}"
                    id="roomBtn-all">
                    üìã ALL ROOMS (${rooms.length} rooms, ${squads.length} squads)
                </button>
                ${rooms.map(room => {
                    const totalPlayers = room.squads.reduce((sum, squad) => sum + squad.players.length, 0);
                    const totalKills = room.squads.reduce((sum, squad) => 
                        sum + squad.players.reduce((pSum, p) => pSum + (p.total || 0), 0), 0);
                    
                    return `
                        <button onclick="switchRoom(${room.roomNumber})" 
                            class="room-nav-btn ${currentRoom === room.roomNumber ? 'active' : ''}"
                            id="roomBtn-${room.roomNumber}">
                            üéÆ ROOM ${room.roomNumber}
                            <span class="text-xs opacity-75 ml-2">
                                (${room.squads.length} squads ‚Ä¢ ${totalPlayers} players ‚Ä¢ ${totalKills} kills)
                            </span>
                        </button>
                    `;
                }).join('')}
            `;
        }

        function switchRoom(roomNumber) {
            currentRoom = roomNumber;
            
            // Update button states
            document.querySelectorAll('.room-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`roomBtn-${roomNumber}`).classList.add('active');
            
            // Re-render squads
            renderSquads();
            
            // Scroll to squads section
            document.getElementById('squadsSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function renderSquads() {
            const container = document.getElementById('squadsSection');
            
            if (squads.length === 0) {
                container.innerHTML = `
                    <div class="card rounded-lg p-20 text-center">
                        <div class="text-gray-600 text-5xl mb-4">üõ°Ô∏è</div>
                        <p class="text-gray-400 text-lg font-semibold">No Squads Registered</p>
                        <p class="text-gray-500 text-sm mt-2">Squads will appear here once registered</p>
                    </div>
                `;
                return;
            }
            
            const roomsToDisplay = currentRoom === 'all' ? rooms : rooms.filter(r => r.roomNumber === currentRoom);
            
            container.innerHTML = roomsToDisplay.map(room => {
                const totalKills = room.squads.reduce((sum, squad) => 
                    sum + squad.players.reduce((pSum, p) => pSum + (p.total || 0), 0), 0);
                
                return `
                    <div class="card rounded-lg p-6 mb-6 shadow-xl">
                        <div class="flex items-center justify-between mb-5 pb-4 border-b border-gray-700">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-600 to-purple-800 flex items-center justify-center">
                                    <span class="text-2xl font-black text-white">${room.roomNumber}</span>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">Room ${room.roomNumber}</h3>
                                    <p class="text-gray-400 text-sm">${room.squads.length} Squads ‚Ä¢ ${room.squads.reduce((sum, s) => sum + s.players.length, 0)} Players</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-orange-500">${totalKills}</div>
                                <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            ${room.squads.map((squad, squadIndex) => {
                                const globalSquadIndex = (room.roomNumber - 1) * SQUADS_PER_ROOM + squadIndex;
                                const squadTotalKills = squad.players.reduce((sum, p) => sum + (p.total || 0), 0);
                                
                                return `
                                    <div class="squad-card p-5" id="squad-${squad._id}">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="text-purple-500 font-bold text-sm">TEAM #${globalSquadIndex + 1}</div>
                                                <div class="text-white font-bold text-xl">${squad.squadName}</div>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="px-3 py-1 rounded-full text-xs font-bold bg-purple-900/30 text-purple-400">
                                                    ${squad.players.length} Players
                                                </span>
                                                <span class="text-orange-500 font-bold text-lg">
                                                    ${squadTotalKills} kills
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm">
                                                <thead>
                                                    <tr class="border-b border-gray-700">
                                                        <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">#</th>
                                                        <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">Player Name</th>
                                                        <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">FF Name</th>
                                                        <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">FF ID</th>
                                                        <th class="p-2 text-center text-gray-400 font-bold uppercase text-xs">Bermuda</th>
                                                        <th class="p-2 text-center text-gray-400 font-bold uppercase text-xs">Purgatory</th>
                                                        <th class="p-2 text-center text-gray-400 font-bold uppercase text-xs">Kalahari</th>
                                                        <th class="p-2 text-center text-orange-500 font-bold uppercase text-xs">Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${squad.players.map((player, pIndex) => `
                                                        <tr class="border-t border-gray-800 hover:bg-white/5">
                                                            <td class="p-2 text-purple-400 font-bold">${pIndex + 1}</td>
                                                            <td class="p-2 text-white font-semibold">${player.playerName}</td>
                                                            <td class="p-2 text-gray-300">${player.ffName}</td>
                                                            <td class="p-2 text-gray-400 font-mono text-xs">${player.ffId}</td>
                                                            <td class="p-2 text-center">
                                                                <input type="number" value="${player.map1 || 0}" min="0" 
                                                                    onchange="updateSquadPlayerKills('${squad._id}', '${player.ffId}', 'map1', this.value)"
                                                                    class="w-16 rounded px-2 py-1 text-center font-semibold text-xs">
                                                            </td>
                                                            <td class="p-2 text-center">
                                                                <input type="number" value="${player.map2 || 0}" min="0" 
                                                                    onchange="updateSquadPlayerKills('${squad._id}', '${player.ffId}', 'map2', this.value)"
                                                                    class="w-16 rounded px-2 py-1 text-center font-semibold text-xs">
                                                            </td>
                                                            <td class="p-2 text-center">
                                                                <input type="number" value="${player.map3 || 0}" min="0" 
                                                                    onchange="updateSquadPlayerKills('${squad._id}', '${player.ffId}', 'map3', this.value)"
                                                                    class="w-16 rounded px-2 py-1 text-center font-semibold text-xs">
                                                            </td>
                                                            <td class="p-2 text-center">
                                                                <span class="text-orange-500 font-bold text-lg">${player.total || 0}</span>
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateSquadPlayerKills(squadId, ffId, map, value) {
            console.log('üîÑ Updating squad player kills:', { squadId, ffId, map, value });
            
            const squad = squads.find(s => s._id === squadId);
            if (!squad) {
                console.error('‚ùå Squad not found:', squadId);
                showAlert('Squad not found', 'error');
                return;
            }
            
            const player = squad.players.find(p => p.ffId === ffId);
            if (!player) {
                console.error('‚ùå Player not found:', ffId);
                showAlert('Player not found in squad', 'error');
                return;
            }
            
            // Store old value for rollback
            const oldValue = player[map];
            
            // Update local data immediately for responsive UI
            player[map] = parseInt(value) || 0;
            player.total = (player.map1 || 0) + (player.map2 || 0) + (player.map3 || 0);
            
            // Re-render immediately
            organizeRooms();
            renderRoomNavigation();
            renderSquads();
            updateStats();
            
            try {
                console.log('üì§ Sending update to backend...');
                
                // Update squad player kills in backend
                const response = await fetch(`${API_BASE}/kills/updateSquadPlayerKills`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        squadId: squadId,
                        ffId: ffId,
                        map1: player.map1 || 0,
                        map2: player.map2 || 0,
                        map3: player.map3 || 0
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    console.error('‚ùå Backend error:', errorData);
                    
                    // Rollback on error
                    player[map] = oldValue;
                    player.total = (player.map1 || 0) + (player.map2 || 0) + (player.map3 || 0);
                    
                    organizeRooms();
                    renderRoomNavigation();
                    renderSquads();
                    updateStats();
                    
                    showAlert(`Failed: ${errorData.message || 'Update failed'}`, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('‚úÖ Backend update successful:', result);
                
                // Save game state
                await saveGameState();
                
            } catch (error) {
                console.error('‚ùå Network error updating squad player kills:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    apiBase: API_BASE
                });
                
                // Rollback on network error
                player[map] = oldValue;
                player.total = (player.map1 || 0) + (player.map2 || 0) + (player.map3 || 0);
                
                organizeRooms();
                renderRoomNavigation();
                renderSquads();
                updateStats();
                
                showAlert(`Network Error: ${error.message}`, 'error');
                
                // Still save to game state for persistence
                await saveGameState();
            }
        }

        function searchSquads() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // Show all squads
                currentRoom = 'all';
                renderRoomNavigation();
                renderSquads();
                return;
            }
            
            // Filter squads based on search
            const filteredSquads = squads.filter(squad => {
                const squadNameMatch = squad.squadName.toLowerCase().includes(searchTerm);
                const playerMatch = squad.players.some(player => 
                    player.playerName.toLowerCase().includes(searchTerm) ||
                    player.ffName.toLowerCase().includes(searchTerm) ||
                    player.ffId.toLowerCase().includes(searchTerm)
                );
                return squadNameMatch || playerMatch;
            });
            
            // Render filtered results
            const container = document.getElementById('squadsSection');
            
            if (filteredSquads.length === 0) {
                container.innerHTML = `
                    <div class="card rounded-lg p-20 text-center">
                        <div class="text-gray-600 text-5xl mb-4">üîç</div>
                        <p class="text-gray-400 text-lg font-semibold">No Results Found</p>
                        <p class="text-gray-500 text-sm mt-2">Try a different search term</p>
                    </div>
                `;
                return;
            }
            
            const totalKills = filteredSquads.reduce((sum, squad) => 
                sum + squad.players.reduce((pSum, p) => pSum + (p.total || 0), 0), 0);
            
            container.innerHTML = `
                <div class="card rounded-lg p-6 mb-6 shadow-xl">
                    <div class="flex items-center justify-between mb-5 pb-4 border-b border-gray-700">
                        <div>
                            <h3 class="text-2xl font-bold text-white">üîç Search Results</h3>
                            <p class="text-gray-400 text-sm">${filteredSquads.length} Squads Found</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold text-orange-500">${totalKills}</div>
                            <div class="text-xs text-gray-400 uppercase">Total Kills</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${filteredSquads.map((squad, squadIndex) => {
                            const squadTotalKills = squad.players.reduce((sum, p) => sum + (p.total || 0), 0);
                            
                            return `
                                <div class="squad-card p-5" id="squad-${squad._id}">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="text-purple-500 font-bold text-sm">TEAM #${squadIndex + 1}</div>
                                            <div class="text-white font-bold text-xl">${squad.squadName}</div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-purple-900/30 text-purple-400">
                                                ${squad.players.length} Players
                                            </span>
                                            <span class="text-orange-500 font-bold text-lg">
                                                ${squadTotalKills} kills
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-gray-700">
                                                    <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">#</th>
                                                    <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">Player Name</th>
                                                    <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">FF Name</th>
                                                    <th class="p-2 text-left text-gray-400 font-bold uppercase text-xs">FF ID</th>
                                                    <th class="p-2 text-center text-gray-400 font-bold uppercase text-xs">Bermuda</th>
                                                    <th class="p-2 text-center text-gray-400 font-bold uppercase text-xs">Purgatory</th>
                                                    <th class="p-2 text-center text-gray-400 font-bold uppercase text-xs">Kalahari</th>
                                                    <th class="p-2 text-center text-orange-500 font-bold uppercase text-xs">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${squad.players.map((player, pIndex) => `
                                                    <tr class="border-t border-gray-800 hover:bg-white/5">
                                                        <td class="p-2 text-purple-400 font-bold">${pIndex + 1}</td>
                                                        <td class="p-2 text-white font-semibold">${player.playerName}</td>
                                                        <td class="p-2 text-gray-300">${player.ffName}</td>
                                                        <td class="p-2 text-gray-400 font-mono text-xs">${player.ffId}</td>
                                                        <td class="p-2 text-center">
                                                            <input type="number" value="${player.map1 || 0}" min="0" 
                                                                onchange="updateSquadPlayerKills('${squad._id}', '${player.ffId}', 'map1', this.value)"
                                                                class="w-16 rounded px-2 py-1 text-center font-semibold text-xs">
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            <input type="number" value="${player.map2 || 0}" min="0" 
                                                                onchange="updateSquadPlayerKills('${squad._id}', '${player.ffId}', 'map2', this.value)"
                                                                class="w-16 rounded px-2 py-1 text-center font-semibold text-xs">
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            <input type="number" value="${player.map3 || 0}" min="0" 
                                                                onchange="updateSquadPlayerKills('${squad._id}', '${player.ffId}', 'map3', this.value)"
                                                                class="w-16 rounded px-2 py-1 text-center font-semibold text-xs">
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            <span class="text-orange-500 font-bold text-lg">${player.total || 0}</span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function showTopPlayersModal() {
            if (players.length === 0) {
                showAlert('No players to select from', 'error');
                return;
            }
            
            const modal = document.getElementById('topPlayersModal');
            const select = document.getElementById('topPlayersCount');
            
            select.onchange = function() {
                if (this.value === 'custom') {
                    document.getElementById('customSelectionDiv').style.display = 'block';
                    renderPlayerSelectionList();
                } else {
                    document.getElementById('customSelectionDiv').style.display = 'none';
                }
            };
            
            modal.style.display = 'block';
        }

        function closeTopPlayersModal() {
            document.getElementById('topPlayersModal').style.display = 'none';
        }

        function renderPlayerSelectionList() {
            const container = document.getElementById('playerSelectionList');
            container.innerHTML = players.map((player, index) => `
                <label class="flex items-center p-3 hover:bg-white/5 cursor-pointer rounded mb-2">
                    <input type="checkbox" class="checkbox-player" value="${player._id}" 
                        ${selectedTopPlayers.includes(player._id) ? 'checked' : ''}>
                    <span class="text-white font-semibold">${index + 1}. ${player.playerName}</span>
                    <span class="text-gray-400 ml-2">(${player.total} kills)</span>
                </label>
            `).join('');
        }

        async function applyTopPlayersSelection() {
            const select = document.getElementById('topPlayersCount');
            
            if (select.value === 'custom') {
                const checkboxes = document.querySelectorAll('.checkbox-player:checked');
                selectedTopPlayers = Array.from(checkboxes).map(cb => cb.value);
            } else {
                const count = parseInt(select.value);
                selectedTopPlayers = players.slice(0, count).map(p => p._id);
            }
            
            displayTopPlayers();
            closeTopPlayersModal();
            await saveGameState();
        }

        function displayTopPlayers() {
            const section = document.getElementById('topPlayersSection');
            const container = document.getElementById('topPlayersContainer');
            
            if (selectedTopPlayers.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            const topPlayers = players.filter(p => selectedTopPlayers.includes(p._id));
            
            container.innerHTML = topPlayers.map((player) => {
                const rank = players.indexOf(player) + 1;
                
                return `
                    <div class="top-player-card">
                        <div class="text-4xl font-black text-yellow-400 mb-2">#${rank}</div>
                        <div class="text-lg font-bold text-white mb-1">${player.playerName}</div>
                        <div class="text-sm text-gray-400 mb-2">${player.ffName}</div>
                        <div class="text-2xl font-bold text-orange-500">${player.total} Kills</div>
                    </div>
                `;
            }).join('');
            
            section.style.display = 'block';
        }

        function updateStats() {
            const totalPlayers = players.length;
            const totalSquads = squads.length;
            const totalRooms = rooms.length;
            const totalKills = players.reduce((sum, p) => sum + p.total, 0) + 
                              squads.reduce((sum, squad) => 
                                  sum + squad.players.reduce((pSum, p) => pSum + (p.total || 0), 0), 0);

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalSquads').textContent = totalSquads;
            document.getElementById('totalRooms').textContent = totalRooms;
            document.getElementById('totalKills').textContent = totalKills;
        }

       async function deletePlayer(id) {
            if (confirm('Delete this player? This cannot be undone.')) {
                try {
                    const response = await fetch(`${API_BASE}/kills/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        selectedTopPlayers = selectedTopPlayers.filter(pid => pid !== id);
                        await loadPlayers();
                        displayTopPlayers();
                        await saveGameState();
                        showAlert('Player deleted successfully', 'success');
                    } else {
                        throw new Error('Failed to delete player');
                    }
                } catch (error) {
                    showAlert('Error: ' + error.message, 'error');
                }
            }
        }

        async function updateKills(id, map, value) {
            const player = players.find(p => p._id === id);
            if (!player) return;

            player[map] = parseInt(value) || 0;
            player.total = player.map1 + player.map2 + player.map3;

            try {
                await fetch(`${API_BASE}/kills/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        map1: player.map1,
                        map2: player.map2,
                        map3: player.map3
                    })
                });

                sortAndRank();
                displayTopPlayers();
                updateStats();
            } catch (error) {
                console.error('Error updating kills:', error);
                showAlert('Failed to update kills', 'error');
            }
        }

        function sortAndRank() {
            players.sort((a, b) => b.total - a.total);
            renderTable();
            updateStats();
        }

        function renderTable() {
            const tbody = document.getElementById('scoreTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (players.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = players.map((player, index) => {
                const rank = index + 1;
                const isTop48 = rank <= 48;
                const isTop3 = rank <= 3;
                const rowClass = isTop48 ? 'top-player accent-border' : 'accent-border';
                const isSelected = selectedTopPlayers.includes(player._id);
                
                return `
                    <tr class="${rowClass} border-b border-gray-800">
                        <td class="p-4 text-center">
                            <input type="checkbox" class="checkbox-player" ${isSelected ? 'checked' : ''} 
                                onchange="toggleTopPlayerSelection('${player._id}', this.checked)">
                        </td>
                        <td class="p-4">
                            <div class="rank-badge ${isTop3 ? 'top-3' : ''} rounded">${rank}</div>
                        </td>
                        <td class="p-4 font-semibold">${player.playerName}</td>
                        <td class="p-4 text-gray-300">${player.ffName}</td>
                        <td class="p-4 text-gray-400 font-mono text-xs">${player.ffId}</td>
                        <td class="p-4 text-center">
                            <input type="number" value="${player.map1}" min="0" 
                                onchange="updateKills('${player._id}', 'map1', this.value)"
                                class="w-16 rounded px-2 py-1 text-center font-semibold text-sm">
                        </td>
                        <td class="p-4 text-center">
                            <input type="number" value="${player.map2}" min="0" 
                                onchange="updateKills('${player._id}', 'map2', this.value)"
                                class="w-16 rounded px-2 py-1 text-center font-semibold text-sm">
                        </td>
                        <td class="p-4 text-center">
                            <input type="number" value="${player.map3}" min="0" 
                                onchange="updateKills('${player._id}', 'map3', this.value)"
                                class="w-16 rounded px-2 py-1 text-center font-semibold text-sm">
                        </td>
                        <td class="p-4 text-center">
                            <span class="text-xl font-bold text-orange-500">${player.total}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="deletePlayer('${player._id}')" 
                                class="delete-btn text-gray-400 hover:text-red-500 font-bold text-lg">
                                ‚úï
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function toggleTopPlayerSelection(playerId, checked) {
            if (checked) {
                if (!selectedTopPlayers.includes(playerId)) {
                    selectedTopPlayers.push(playerId);
                }
            } else {
                selectedTopPlayers = selectedTopPlayers.filter(id => id !== playerId);
            }
            displayTopPlayers();
            await saveGameState();
        }

       function exportXLSX(type) {
            if (players.length === 0 && squads.length === 0) {
                showAlert('No data to export', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();

            if (type === 'singles' || type === 'complete') {
                if (players.length > 0) {
                    const singlesData = players.map((p, i) => ({
                        'Rank': i + 1,
                        'Player Name': p.playerName,
                        'FF Name': p.ffName || '-',
                        'FF ID': p.ffId || '-',
                        'Bermuda': p.map1 || 0,
                        'Purgatory': p.map2 || 0,
                        'Kalahari': p.map3 || 0,
                        'Total Kills': p.total || 0
                    }));
                    const ws = XLSX.utils.json_to_sheet(singlesData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Individual Players');
                }
            }

            if (type === 'top48' || type === 'complete') {
                if (players.length > 0) {
                    const top48Data = players.slice(0, 48).map((p, i) => ({
                        'Rank': i + 1,
                        'Player Name': p.playerName,
                        'FF Name': p.ffName || '-',
                        'FF ID': p.ffId || '-',
                        'Bermuda': p.map1 || 0,
                        'Purgatory': p.map2 || 0,
                        'Kalahari': p.map3 || 0,
                        'Total Kills': p.total || 0
                    }));
                    const ws = XLSX.utils.json_to_sheet(top48Data);
                    XLSX.utils.book_append_sheet(wb, ws, 'Top 48 Players');
                }
            }

            if (type === 'squads' || type === 'complete') {
                if (squads.length > 0) {
                    const squadsData = [];
                    squads.forEach((squad, squadIndex) => {
                        squad.players.forEach((player, playerIndex) => {
                            squadsData.push({
                                'Squad #': squadIndex + 1,
                                'Squad Name': squad.squadName,
                                'Player Position': playerIndex + 1,
                                'Player Name': player.playerName,
                                'FF Name': player.ffName || '-',
                                'FF ID': player.ffId || '-',
                                'Bermuda': player.map1 || 0,
                                'Purgatory': player.map2 || 0,
                                'Kalahari': player.map3 || 0,
                                'Total Kills': player.total || 0
                            });
                        });
                        squadsData.push({});
                    });
                    const ws = XLSX.utils.json_to_sheet(squadsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Squads');
                }
            }

            if (type === 'rooms' || type === 'complete') {
                if (rooms.length > 0) {
                    rooms.forEach(room => {
                        const roomData = [];
                        room.squads.forEach((squad, squadIndex) => {
                            squad.players.forEach((player, playerIndex) => {
                                roomData.push({
                                    'Team #': ((room.roomNumber - 1) * SQUADS_PER_ROOM) + squadIndex + 1,
                                    'Squad Name': squad.squadName,
                                    'Position': playerIndex + 1,
                                    'Player Name': player.playerName,
                                    'FF Name': player.ffName || '-',
                                    'FF ID': player.ffId || '-',
                                    'Bermuda': player.map1 || 0,
                                    'Purgatory': player.map2 || 0,
                                    'Kalahari': player.map3 || 0,
                                    'Total': player.total || 0
                                });
                            });
                            roomData.push({});
                        });
                        const ws = XLSX.utils.json_to_sheet(roomData);
                        XLSX.utils.book_append_sheet(wb, ws, `Room ${room.roomNumber}`);
                    });
                }
            }

            const fileName = type === 'complete' ? 'tournament_complete.xlsx' :
                type === 'top48' ? 'top48_players.xlsx' :
                    type === 'squads' ? 'squads_roster.xlsx' :
                        type === 'rooms' ? 'tournament_rooms.xlsx' :
                            'individual_players.xlsx';

            XLSX.writeFile(wb, fileName);
            closeExportModal();
            showAlert(`Exported ${fileName} successfully!`, 'success');
        }

        function showExportModal() {
            const modal = document.getElementById('exportModal');
            modal.style.display = 'block';
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            modal.style.display = 'none';
        }

        document.addEventListener('click', function(event) {
            const exportModal = document.getElementById('exportModal');
            const topPlayersModal = document.getElementById('topPlayersModal');
            
            if (event.target === exportModal) {
                closeExportModal();
            }
            if (event.target === topPlayersModal) {
                closeTopPlayersModal();
            }
        });

        async function clearAllData() {
            const confirmed = confirm(
                '‚ö†Ô∏è CLEAR ALL DATA?\n\n' +
                'This will PERMANENTLY delete:\n' +
                '‚Ä¢ All individual players\n' +
                '‚Ä¢ All squads\n' +
                '‚Ä¢ All scores\n' +
                '‚Ä¢ All game states\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Type "DELETE" to confirm'
            );
            
            if (!confirmed) return;

            const verification = prompt('Type DELETE to confirm:');
            if (verification !== 'DELETE') {
                showAlert('Deletion cancelled', 'warning');
                return;
            }

            try {
                // Delete all individual players
                await fetch(`${API_BASE}/kills/deleteAll`, {
                    method: 'DELETE'
                });

                // Delete all squads
                const squadsResponse = await fetch(`${API_BASE}/kills/getSquads`);
                const squadsData = await squadsResponse.json();
                const squadsList = Array.isArray(squadsData) ? squadsData : (squadsData.squads || []);
                
                for (const squad of squadsList) {
                    await fetch(`${API_BASE}/kills/deleteSquad/${squad._id}`, {
                        method: 'DELETE'
                    });
                }

                // Clear game state
                await fetch(`${API_BASE}/gamestate`, {
                    method: 'DELETE'
                });

                players = [];
                squads = [];
                rooms = [];
                selectedTopPlayers = [];
                gameState = null;
                currentRoom = 'all';

                renderTable();
                renderSquads();
                renderRoomNavigation();
                updateStats();
                displayTopPlayers();

                showAlert('All data cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing data:', error);
                showAlert('Failed to clear data', 'error');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>