<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fire Live Scoreboard - Real-time</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .scoreboard-header {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            border-bottom: var(--border-width-medium) solid var(--color-border);
        }
        
        .live-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            box-shadow: 0 0 20px rgba(255, 0, 102, 0.5);
        }
        
        .rank-cell {
            min-width: 60px;
            font-family: var(--font-heading);
        }
        
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        .score-update {
            animation: scoreFlash 0.6s ease-out;
        }
        
        @keyframes scoreFlash {
            0%, 100% { background: transparent; }
            50% { background: rgba(0, 255, 136, 0.2); }
        }
        
        .new-entry {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: var(--z-tooltip);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: var(--space-2);
        }
        
        .status-connected { background: var(--color-success); }
        .status-disconnected { background: var(--color-error); }
        
        .stat-card {
            background: var(--color-bg-card);
            border: var(--border-width-thin) solid var(--color-border);
            border-radius: var(--border-radius-lg);
            padding: var(--space-4);
            text-align: center;
        }
        
        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-black);
            font-family: var(--font-heading);
            color: var(--color-primary);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status">
        <div class="card" style="padding: var(--space-3);">
            <span class="status-dot status-disconnected" id="statusDot"></span>
            <span id="statusText" class="text-muted">Connecting...</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container" style="padding-top: var(--space-8); padding-bottom: var(--space-8);">
        <!-- Header -->
        <div class="scoreboard-header card animate-fadeIn" style="margin-bottom: var(--space-6);">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="m-0" style="font-family: var(--font-heading); color: var(--color-primary);">
                        FREE FIRE TOURNAMENT
                    </h1>
                    <p class="text-muted" style="margin-top: var(--space-2);">Live Scoreboard</p>
                </div>
                
                <div class="flex gap-4 items-center">
                    <div class="badge badge-error live-badge">
                        <span style="width: 8px; height: 8px; background: white; border-radius: 50%; display: inline-block; margin-right: 8px;"></span>
                        LIVE
                    </div>
                </div>
            </div>
            
            <!-- Stats Row -->
            <div class="grid grid-cols-3 gap-4" style="margin-top: var(--space-6);">
                <div class="stat-card">
                    <div class="stat-value" id="totalPlayers">0</div>
                    <div class="stat-label">Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalKills">0</div>
                    <div class="stat-label">Total Kills</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgKills">0</div>
                    <div class="stat-label">Avg Kills</div>
                </div>
            </div>
        </div>

        <!-- Scoreboard Table -->
        <div class="card animate-fadeIn" style="animation-delay: 0.2s;">
            <div class="card-header">
                <h2 class="card-title">Leaderboard</h2>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="rank-cell">Rank</th>
                            <th>Player Name</th>
                            <th>FF ID</th>
                            <th class="text-center">Bermuda</th>
                            <th class="text-center">Purgatory</th>
                            <th class="text-center">Kalahari</th>
                            <th class="text-center">Total Kills</th>
                        </tr>
                    </thead>
                    <tbody id="scoreboardBody">
                        <tr>
                            <td colspan="7" class="text-center" style="padding: var(--space-16);">
                                <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-4);">ðŸ“Š</div>
                                <p class="text-muted">Waiting for data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Last Updated -->
        <div class="text-center text-muted" style="margin-top: var(--space-6); font-size: var(--font-size-sm);">
            Last updated: <span id="lastUpdated">--:--:--</span>
        </div>
    </div>

    <script>
        // Socket.io connection
        const socket = io();
        
        let players = [];
        let previousScores = {};
        
        // Connection status
        socket.on('connect', () => {
            console.log('âœ… Connected to server');
            updateConnectionStatus(true);
        });
        
        socket.on('disconnect', () => {
            console.log('âŒ Disconnected from server');
            updateConnectionStatus(false);
        });
        
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.className = 'status-dot status-connected';
                text.textContent = 'Connected';
                text.className = 'text-primary';
            } else {
                dot.className = 'status-dot status-disconnected';
                text.textContent = 'Disconnected';
                text.className = 'text-muted';
            }
        }
        
        // Real-time events
        socket.on('playerAdded', (player) => {
            console.log('New player added:', player);
            loadPlayers();
        });
        
        socket.on('playerUpdated', (player) => {
            console.log('Player updated:', player);
            loadPlayers();
        });
        
        socket.on('playerDeleted', (playerId) => {
            console.log('Player deleted:', playerId);
            loadPlayers();
        });
        
        socket.on('playersImported', (players) => {
            console.log('Players imported:', players.length);
            loadPlayers();
        });
        
        // Initial load
        window.onload = () => {
            loadPlayers();
            // Fallback polling every 10 seconds
            setInterval(loadPlayers, 10000);
        };
        
        async function loadPlayers() {
            try {
                const response = await fetch('/api/kills/getPlayers');
                const data = await response.json();
                
                // Store previous scores for animation
                players.forEach(p => {
                    previousScores[p._id] = p.total;
                });
                
                players = data.map(player => ({
                    _id: player._id,
                    playerName: player.playerName,
                    ffName: player.ffName,
                    ffId: player.ffId,
                    map1: player.map1 || 0,
                    map2: player.map2 || 0,
                    map3: player.map3 || 0,
                    total: player.total || 0
                }));
                
                // Sort by total kills
                players.sort((a, b) => b.total - a.total);
                
                renderScoreboard();
                updateStats();
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }
        
        function renderScoreboard() {
            const tbody = document.getElementById('scoreboardBody');
            
            if (players.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: var(--space-16);">
                            <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-4);">ðŸ“Š</div>
                            <p class="text-muted">No players registered yet</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = players.map((player, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const scoreChanged = previousScores[player._id] !== undefined && 
                                    previousScores[player._id] !== player.total;
                const isNew = previousScores[player._id] === undefined;
                
                return `
                    <tr class="${isNew ? 'new-entry' : ''}" data-player-id="${player._id}">
                        <td class="rank-cell">
                            <span class="badge ${rankClass}" style="min-width: 48px;">
                                ${rank <= 3 ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][rank - 1] : '#' + rank}
                            </span>
                        </td>
                        <td class="font-semibold">${player.playerName}</td>
                        <td class="text-muted">${player.ffId || player.ffName}</td>
                        <td class="text-center ${scoreChanged ? 'score-update' : ''}">${player.map1}</td>
                        <td class="text-center ${scoreChanged ? 'score-update' : ''}">${player.map2}</td>
                        <td class="text-center ${scoreChanged ? 'score-update' : ''}">${player.map3}</td>
                        <td class="text-center">
                            <span class="badge badge-success" style="font-size: var(--font-size-lg); padding: var(--space-2) var(--space-4);">
                                ${player.total}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats() {
            const totalPlayers = players.length;
            const totalKills = players.reduce((sum, p) => sum + p.total, 0);
            const avgKills = totalPlayers > 0 ? Math.round(totalKills / totalPlayers * 10) / 10 : 0;
            
            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('totalKills').textContent = totalKills;
            document.getElementById('avgKills').textContent = avgKills;
        }
        
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastUpdated').textContent = timeString;
        }
    </script>
</body>
</html>
